<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>بوابة المستفيد - تراوف</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all-svg.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="assets/logo.png" alt=""></div>
        <ul class="nav-links">
            <li><a class="active" href="#"><i class="fas fa-id-card"></i> بطاقتي</a></li>
            <li><a href="support.html"><i class="fas fa-headset"></i> الدعم الفني</a></li>
            <li><a href="#" onclick="Auth.logout()"><i class="fas fa-sign-out-alt"></i> تسجيل خروج</a></li>
        </ul>

    </nav>

    <main class="main-content">
        <header>
            <h1><i class="fas fa-user-circle"></i> بوابة المستفيد</h1>
            <div class="user-profile"><span id="welcomeName">مرحباً</span>
                <div class="avatar">م</div>
            </div>
        </header>

        <!-- لا توجد بطاقة -->
        <div id="noCardState" style="text-align:center; display:none;">
            <i class="fas fa-info-circle" style="font-size:3rem; color:#bbb; margin-bottom:20px;"></i>
            <h3>لا توجد بطاقة نشطة مرتبطة بحسابك حالياً.</h3>
        </div>

        <!-- بطاقة فعّالة -->
        <div id="cardDetailsSection">
            <div class="card-preview">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="opacity:.8">رقم البطاقة</span>
                    <span id="cardStatusBadge"
                        style="background:rgba(0,0,0,.2); padding:5px 10px; border-radius:5px; font-size:.8rem;">نشط</span>
                </div>
                <h2 id="cardNumberDisplay">0000 0000</h2>
                <div class="balance-display">
                    الرصيد المتاح: <strong id="cardBalanceDisplay">0.00</strong> ريال
                </div>
                <br>
                <div id="qrBox" class="qr-placeholder"></div>
                <p style="font-size:.9rem; opacity:.9">أبرز هذا الكود عند البائع لإتمام الشراء</p>
            </div>

            <!-- ===== كود الشراء ===== -->
            <div class="form-container" style="border-top: 4px solid var(--brand-teal); margin-top:20px;">
                <h3><i class="fas fa-shopping-cart"></i> إنشاء كود شراء</h3>
                <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">أدخل المبلغ المطلوب لإنشاء كود شراء مؤقت.
                    أعطِ الكود للتاجر لإتمام عملية الشراء.</p>

                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                    <div class="form-group" style="flex:1; min-width:150px; margin-bottom:0;">
                        <label>المبلغ (ريال)</label>
                        <input id="purchaseAmount" type="number" min="1" placeholder="أدخل المبلغ">
                    </div>
                    <button id="btnGenerateCode" onclick="PurchaseCode.generate()"
                        style="background:var(--brand-teal); white-space:nowrap;">
                        <i class="fas fa-ticket-alt"></i> إنشاء كود
                    </button>
                </div>

                <!-- نتيجة الكود -->
                <div id="purchaseCodeResult"
                    style="display:none; margin-top:20px; text-align:center; background:linear-gradient(135deg, #f0faf9, #e8f5e9); border:2px solid var(--brand-teal); border-radius:16px; padding:24px;">
                    <p style="margin:0 0 5px; color:#666; font-size:0.85rem;">كود الشراء الخاص بك</p>
                    <h1 id="generatedCode"
                        style="font-size:2.5rem; letter-spacing:12px; color:var(--brand-ink); margin:10px 0; font-family:monospace;">
                        ------</h1>
                    <div id="purchaseQR" style="display:flex; justify-content:center; margin:15px 0;"></div>
                    <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin:10px 0;">
                        <span><i class="fas fa-money-bill-wave" style="color:var(--brand-teal);"></i> المبلغ: <strong
                                id="codeAmount">0</strong> ريال</span>
                        <span><i class="fas fa-clock" style="color:#e67e22;"></i> ينتهي خلال: <strong id="codeTimer"
                                style="color:#e67e22;">5:00</strong></span>
                    </div>
                    <p style="font-size:0.85rem; color:#888; margin:10px 0 0;">أعطِ هذا الكود للتاجر أو اعرض رمز QR
                        للمسح</p>
                </div>
            </div>

            <h3><i class="fas fa-history"></i> آخر العمليات</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>المتجر</th>
                            <th>المبلغ</th>
                        </tr>
                    </thead>
                    <tbody id="beneficiaryTransactionsTable"></tbody>
                </table>
            </div>
        </div>
        <footer class="main-footer">
            <p>صنع في تراؤف</p>
            <img src="assets/logo.png" alt="TRAOF Logo">
        </footer>
    </main>

    <script src="script.js"></script>
    <script>
        /* ===== Purchase Code Logic ===== */
        const PurchaseCode = {
            timerInterval: null,

            generate: () => {
                const amountInput = document.getElementById('purchaseAmount');
                const amount = parseFloat(amountInput?.value);
                if (!amount || amount <= 0) return alert('يرجى إدخال مبلغ صحيح');

                const user = Auth.user;
                if (!user) return;

                const cards = Storage.get('cards') || [];
                const benefName = user.linkedEntity || user.name;
                const myCard = cards.find(c => c.beneficiary === benefName && (c.status === 'نشط' || c.status === 'Active'));
                if (!myCard) return alert('لا توجد بطاقة نشطة');
                if (Number(myCard.balance) < amount) return alert('الرصيد غير كافي! رصيدك الحالي: ' + Number(myCard.balance).toFixed(2) + ' ريال');

                // Generate 6-digit code
                const code = String(Math.floor(100000 + Math.random() * 900000));
                const expiresAt = Date.now() + (5 * 60 * 1000); // 5 minutes

                // Store purchase code
                const purchaseCodes = Storage.get('purchaseCodes') || [];
                // Remove old codes for this card
                const filtered = purchaseCodes.filter(p => p.cardNumber !== myCard.number);
                filtered.push({
                    code: code,
                    cardNumber: myCard.number,
                    beneficiary: myCard.beneficiary,
                    identity: myCard.identity || '',
                    wallet: myCard.wallet,
                    amount: amount,
                    expiresAt: expiresAt,
                    used: false
                });
                Storage.set('purchaseCodes', filtered);

                // Display
                document.getElementById('generatedCode').innerText = code;
                document.getElementById('codeAmount').innerText = amount.toFixed(2);
                document.getElementById('purchaseCodeResult').style.display = 'block';

                // Generate QR with code
                const qrContainer = document.getElementById('purchaseQR');
                qrContainer.innerHTML = '';
                if (window.QRCode) {
                    new QRCode(qrContainer, { text: 'PAY:' + code, width: 160, height: 160 });
                }

                // Start countdown
                PurchaseCode.startTimer(expiresAt);

                if (typeof showToast === 'function') showToast('تم إنشاء كود الشراء!', 'success');
            },

            startTimer: (expiresAt) => {
                if (PurchaseCode.timerInterval) clearInterval(PurchaseCode.timerInterval);
                const timerEl = document.getElementById('codeTimer');

                PurchaseCode.timerInterval = setInterval(() => {
                    const remaining = expiresAt - Date.now();
                    if (remaining <= 0) {
                        clearInterval(PurchaseCode.timerInterval);
                        timerEl.innerText = 'انتهى!';
                        timerEl.style.color = '#c0392b';
                        document.getElementById('generatedCode').style.opacity = '0.3';
                        return;
                    }
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    timerEl.innerText = mins + ':' + String(secs).padStart(2, '0');
                }, 1000);
            }
        };

        function initBeneficiary() {
            const user = Auth.user;
            if (!user || user.role !== 'beneficiary') return;

            const welcome = document.getElementById('welcomeName');
            if (welcome) welcome.innerText = `مرحباً، ${user.name}`;

            const cards = Storage.get('cards') || [];
            const benefName = user.linkedEntity || user.name;
            const myCard = cards.find(c => (c.beneficiary === benefName) && (c.status === 'نشط' || c.status === 'Active'));

            const cardSection = document.getElementById('cardDetailsSection');
            const noCard = document.getElementById('noCardState');

            if (myCard) {
                document.getElementById('cardNumberDisplay').innerText = myCard.number;
                document.getElementById('cardBalanceDisplay').innerText = Number(myCard.balance || 0).toFixed(2);

                const transactions = Storage.get('transactions') || [];
                const myTrans = transactions.filter(t => t.card === myCard.number);
                const tbody = document.getElementById('beneficiaryTransactionsTable');

                if (tbody) {
                    if (myTrans.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">لا توجد عمليات سابقة</td></tr>';
                    } else {
                        tbody.innerHTML = myTrans.map(t => `
              <tr>
                <td>${t.date}</td>
                <td>${t.merchant}</td>
                <td style="color:red; font-weight:bold">-${Number(t.amount || 0).toFixed(2)} ريال</td>
              </tr>
            `).join('');
                    }
                }
                if (cardSection) cardSection.style.display = '';
                if (noCard) noCard.style.display = 'none';
                // Render QR code with card number
                renderBeneficiaryQR('qrBox', myCard.number);
            } else {
                if (cardSection) cardSection.style.display = 'none';
                if (noCard) noCard.style.display = 'block';
            }
        }
    </script>
</body>

</html>