<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>بوابة المستفيد - تراوف</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all-svg.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="assets/logo.png" alt=""></div>
        <ul class="nav-links">
            <li><a class="active" href="#"><i class="fas fa-id-card"></i> بطاقتي</a></li>
            <li><a href="support.html"><i class="fas fa-headset"></i> الدعم الفني</a></li>
            <li><a href="#" onclick="Auth.logout()"><i class="fas fa-sign-out-alt"></i> تسجيل خروج</a></li>
        </ul>

    </nav>

    <main class="main-content">
        <header>
            <h1><i class="fas fa-user-circle"></i> بوابة المستفيد</h1>
            <div class="user-profile"><span id="welcomeName">مرحباً</span>
                <div class="avatar">م</div>
            </div>
        </header>

        <!-- لا توجد بطاقة -->
        <div id="noCardState" style="text-align:center; display:none;">
            <i class="fas fa-info-circle" style="font-size:3rem; color:#bbb; margin-bottom:20px;"></i>
            <h3>لا توجد بطاقة نشطة مرتبطة بحسابك حالياً.</h3>
        </div>

        <!-- بطاقة فعّالة -->
        <div id="cardDetailsSection">
            <div class="card-preview">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="opacity:.8">رقم البطاقة</span>
                    <span id="cardStatusBadge"
                        style="background:rgba(0,0,0,.2); padding:5px 10px; border-radius:5px; font-size:.8rem;">نشط</span>
                </div>
                <h2 id="cardNumberDisplay">0000 0000</h2>
                <div class="balance-display">
                    الرصيد المتاح: <strong id="cardBalanceDisplay">0.00</strong> ريال
                </div>
                <br>
                <div id="qrBox" class="qr-placeholder"></div>
                <p style="font-size:.9rem; opacity:.9">أبرز هذا الكود عند البائع لإتمام الشراء</p>
            </div>

            <!-- ===== طلبات الشراء الواردة ===== -->
            <div class="form-container" style="border-top: 4px solid #8CC240; margin-top:20px;">
                <h3><i class="fas fa-bell"></i> طلبات الشراء الواردة</h3>
                <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">عند قيام التاجر بإنشاء طلب شراء ستظهر
                    التفاصيل هنا لتأكيدها أو رفضها.</p>

                <div id="noPendingState" style="text-align:center; padding:20px; color:#999;">
                    <i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
                    لا توجد طلبات شراء حالياً
                </div>

                <div id="pendingPurchaseCard"
                    style="display:none; background:linear-gradient(135deg, #fff9e6, #fff3cd); border:2px solid #f0ad4e; border-radius:16px; padding:24px; text-align:center;">
                    <p style="margin:0 0 5px; color:#856404; font-size:0.9rem;"><i class="fas fa-store"></i> طلب شراء من
                        التاجر</p>
                    <h4 id="pendingMerchant" style="color:#856404; margin:5px 0;">-</h4>

                    <div style="margin:15px 0;">
                        <p style="color:#666; font-size:0.85rem; margin:0;">كود التحقق</p>
                        <h1 id="pendingCode"
                            style="font-size:2.5rem; letter-spacing:12px; color:var(--brand-ink); margin:5px 0; font-family:monospace;">
                            ------</h1>
                    </div>

                    <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin:15px 0;">
                        <span><i class="fas fa-money-bill-wave" style="color:#8CC240;"></i> المبلغ: <strong
                                id="pendingAmount" style="font-size:1.3rem; color:#8CC240;">0</strong> ريال</span>
                        <span><i class="fas fa-clock" style="color:#e67e22;"></i> ينتهي خلال: <strong id="pendingTimer"
                                style="color:#e67e22;">5:00</strong></span>
                    </div>

                    <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                        <button onclick="PendingPurchase.confirm()"
                            style="background:#28a745; padding:12px 30px; font-size:1.1rem;">
                            <i class="fas fa-check-circle"></i> تأكيد الشراء
                        </button>
                        <button onclick="PendingPurchase.reject()"
                            style="background:#dc3545; padding:12px 30px; font-size:1.1rem;">
                            <i class="fas fa-times-circle"></i> رفض
                        </button>
                    </div>
                </div>
            </div>

            <h3><i class="fas fa-history"></i> آخر العمليات</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>المتجر</th>
                            <th>المبلغ</th>
                        </tr>
                    </thead>
                    <tbody id="beneficiaryTransactionsTable"></tbody>
                </table>
            </div>
        </div>
        <footer class="main-footer">
            <p>صنع في تراؤف</p>
            <img src="assets/logo.png" alt="TRAOF Logo">
        </footer>
    </main>

    <script src="script.js"></script>
    <script>
        /* ===== Pending Purchase Requests (from merchant) ===== */
        const PendingPurchase = {
            pollInterval: null,
            currentRequest: null,
            timerInterval: null,

            startPolling: () => {
                PendingPurchase.checkOnce();
                if (PendingPurchase.pollInterval) clearInterval(PendingPurchase.pollInterval);
                PendingPurchase.pollInterval = setInterval(() => PendingPurchase.checkOnce(), 3000);
            },

            checkOnce: () => {
                const user = Auth.user;
                if (!user) { console.log('[PendingPurchase] No user logged in'); return; }
                const benefName = user.linkedEntity || user.name;

                // Find ALL cards belonging to this beneficiary
                const cards = Storage.get('cards') || [];
                let myCards = [];

                // 1. By identity
                if (/^\d+$/.test(user.username)) {
                    const byId = cards.filter(c => c.identity === user.username);
                    myCards.push(...byId);
                }

                // 2. By name
                const byName = cards.filter(c => c.beneficiary === benefName);
                myCards.push(...byName);

                // 3. By partial name
                const byPartial = cards.filter(c => c.beneficiary && c.beneficiary.includes(benefName));
                myCards.push(...byPartial);

                // Deduplicate cards by number
                const uniqueCards = [...new Map(myCards.map(item => [item.number, item])).values()];
                const myCardNumbers = uniqueCards.map(c => c.number);

                const pending = Storage.get('pendingPurchases') || [];
                console.log('[PendingPurchase] Checking:', { benefName, myCardNumbers, pendingCount: pending.length, pending: pending.map(p => ({ code: p.code, status: p.status, beneficiary: p.beneficiary, cardNumber: p.cardNumber, expired: Date.now() > p.expiresAt })) });

                // Check if request matches name OR matches ANY of the user's card numbers
                const req = pending.find(p => p.status === 'pending' && Date.now() < p.expiresAt &&
                    (p.beneficiary === benefName || myCardNumbers.includes(p.cardNumber))
                );

                if (req) {
                    console.log('[PendingPurchase] ✅ Found matching request:', req.code, req.amount);
                    PendingPurchase.currentRequest = req;
                    document.getElementById('noPendingState').style.display = 'none';
                    document.getElementById('pendingPurchaseCard').style.display = 'block';
                    document.getElementById('pendingMerchant').innerText = req.merchant || 'تاجر';
                    document.getElementById('pendingCode').innerText = req.code;
                    document.getElementById('pendingAmount').innerText = Number(req.amount).toFixed(2);
                    PendingPurchase.startTimer(req.expiresAt);
                } else {
                    console.log('[PendingPurchase] ❌ No matching pending request found');
                    if (PendingPurchase.currentRequest) {
                        // Was showing, now gone (expired/processed)
                        PendingPurchase.currentRequest = null;
                    }
                    document.getElementById('noPendingState').style.display = '';
                    document.getElementById('pendingPurchaseCard').style.display = 'none';
                }
            },

            startTimer: (expiresAt) => {
                if (PendingPurchase.timerInterval) clearInterval(PendingPurchase.timerInterval);
                const timerEl = document.getElementById('pendingTimer');
                PendingPurchase.timerInterval = setInterval(() => {
                    const remaining = expiresAt - Date.now();
                    if (remaining <= 0) {
                        clearInterval(PendingPurchase.timerInterval);
                        timerEl.innerText = 'انتهى!';
                        timerEl.style.color = '#c0392b';
                        PendingPurchase.checkOnce();
                        return;
                    }
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    timerEl.innerText = mins + ':' + String(secs).padStart(2, '0');
                }, 1000);
            },

            confirm: () => {
                const req = PendingPurchase.currentRequest;
                if (!req) return alert('لا يوجد طلب شراء للتأكيد');

                // Only verify balance is sufficient (don't deduct yet - POS will do that)
                const cards = Storage.get('cards') || [];
                const card = cards.find(c => c.number === req.cardNumber);
                if (!card) return alert('لم يتم العثور على البطاقة');
                if (Number(card.balance) < req.amount) return alert('رصيد البطاقة غير كافي');

                // Update status to confirmed (balance deduction happens at POS)
                const pending = Storage.get('pendingPurchases') || [];
                const p = pending.find(x => x.code === req.code);
                if (p) p.status = 'confirmed';
                Storage.set('pendingPurchases', pending);

                PendingPurchase.currentRequest = null;
                document.getElementById('pendingPurchaseCard').style.display = 'none';
                document.getElementById('noPendingState').style.display = '';

                alert('✅ تم تأكيد طلب الشراء!\nالمبلغ: ' + req.amount.toFixed(2) + ' ريال\nسيتم خصم المبلغ عند إتمام العملية في نقطة البيع.');
                if (typeof showToast === 'function') showToast('تم تأكيد طلب الشراء!', 'success');
            },

            reject: () => {
                const req = PendingPurchase.currentRequest;
                if (!req) return;

                const pending = Storage.get('pendingPurchases') || [];
                const p = pending.find(x => x.code === req.code);
                if (p) p.status = 'rejected';
                Storage.set('pendingPurchases', pending);

                PendingPurchase.currentRequest = null;
                document.getElementById('pendingPurchaseCard').style.display = 'none';
                document.getElementById('noPendingState').style.display = '';

                alert('تم رفض طلب الشراء');
            }
        };

        function initBeneficiary() {
            const user = Auth.user;
            if (!user || user.role !== 'beneficiary') return;

            const welcome = document.getElementById('welcomeName');
            if (welcome) welcome.innerText = `مرحباً، ${user.name}`;

            const cards = Storage.get('cards') || [];
            const benefName = user.linkedEntity || user.name;

            // Robust matching:
            // 1. Match by identity (if username looks like identity)
            let myCard = null;
            if (/^\d+$/.test(user.username)) {
                myCard = cards.find(c => c.identity === user.username && (c.status === 'نشط' || c.status === 'Active'));
            }

            // 2. Match by exact beneficiary name
            if (!myCard) {
                myCard = cards.find(c => c.beneficiary === benefName && (c.status === 'نشط' || c.status === 'Active'));
            }

            // 3. Match by partial name
            if (!myCard) {
                myCard = cards.find(c => c.beneficiary && c.beneficiary.includes(benefName) && (c.status === 'نشط' || c.status === 'Active'));
            }

            const cardSection = document.getElementById('cardDetailsSection');
            const noCard = document.getElementById('noCardState');

            if (myCard) {
                document.getElementById('cardNumberDisplay').innerText = myCard.number;
                document.getElementById('cardBalanceDisplay').innerText = Number(myCard.balance || 0).toFixed(2);

                const transactions = Storage.get('transactions') || [];
                // Match transactions by card number OR beneficiary name
                const myTrans = transactions.filter(t => t.card === myCard.number);

                const tbody = document.getElementById('beneficiaryTransactionsTable');

                if (tbody) {
                    if (myTrans.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">لا توجد عمليات سابقة</td></tr>';
                    } else {
                        tbody.innerHTML = myTrans.map(t => `
              <tr>
                <td>${t.date}</td>
                <td>${t.merchant}</td>
                <td style="color:red; font-weight:bold">-${Number(t.amount || 0).toFixed(2)} ريال</td>
              </tr>
            `).join('');
                    }
                }
                if (cardSection) cardSection.style.display = '';
                if (noCard) noCard.style.display = 'none';
                // Render QR code with card number
                renderBeneficiaryQR('qrBox', myCard.number);
            } else {
                if (cardSection) cardSection.style.display = 'none';
                if (noCard) noCard.style.display = 'block';
            }

            // Start polling for incoming purchase requests from merchants
            PendingPurchase.startPolling();

            // DEBUG: Dump state to help troubleshooting
            console.log('--- DEBUG STATE ---');
            console.log('User:', Auth.user);
            console.log('All Cards:', Storage.get('cards'));
            console.log('All Pending:', Storage.get('pendingPurchases'));
            console.log('-------------------');
        }
    </script>
</body>

</html>