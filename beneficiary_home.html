<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>ุจูุงุจุฉ ุงููุณุชููุฏ - ุชุฑุงูู</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all-svg.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- PWA / Mobile App Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00A59B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="assets/logo.png" alt=""></div>
        <ul class="nav-links">
            <li><a class="active" href="#"><i class="fas fa-id-card"></i> ุจุทุงูุชู</a></li>
            <li><a href="support.html"><i class="fas fa-headset"></i> ุงูุฏุนู ุงูููู</a></li>
            <li><a href="#" onclick="Auth.logout()"><i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุฎุฑูุฌ</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header>
            <h1><i class="fas fa-user-circle"></i> ุจูุงุจุฉ ุงููุณุชููุฏ</h1>
            <div class="user-profile"><span id="welcomeName">ูุฑุญุจุงู</span>
                <div class="avatar">ู</div>
            </div>
        </header>

        <!-- ูุง ุชูุฌุฏ ุจุทุงูุฉ -->
        <div id="noCardState" style="text-align:center; display:none;">
            <i class="fas fa-info-circle" style="font-size:3rem; color:#bbb; margin-bottom:20px;"></i>
            <h3>ูุง ุชูุฌุฏ ุจุทุงูุฉ ูุดุทุฉ ูุฑุชุจุทุฉ ุจุญุณุงุจู ุญุงููุงู.</h3>
        </div>

        <!-- ุจุทุงูุฉ ูุนูุงูุฉ -->
        <div id="cardDetailsSection">
            <div class="card-preview">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="opacity:.8">ุฑูู ุงูุจุทุงูุฉ</span>
                    <span id="cardStatusBadge"
                        style="background:rgba(0,0,0,.2); padding:5px 10px; border-radius:5px; font-size:.8rem;">ูุดุท</span>
                </div>
                <h2 id="cardNumberDisplay">0000 0000</h2>
                <div class="balance-display">
                    ุงูุฑุตูุฏ ุงููุชุงุญ: <strong id="cardBalanceDisplay">0.00</strong> ุฑูุงู
                </div>
                <br>
                <div id="qrBox" class="qr-placeholder"></div>
                <p style="font-size:.9rem; opacity:.9">ุฃุจุฑุฒ ูุฐุง ุงูููุฏ ุนูุฏ ุงูุจุงุฆุน ูุฅุชูุงู ุงูุดุฑุงุก</p>
            </div>

            <!-- ===== ุทูุจุงุช ุงูุดุฑุงุก ุงููุงุฑุฏุฉ ===== -->
            <div class="form-container" style="border-top: 4px solid #8CC240; margin-top:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3><i class="fas fa-bell"></i> ุทูุจุงุช ุงูุดุฑุงุก ุงููุงุฑุฏุฉ</h3>
                    <button class="secondary" style="padding:5px 12px; font-size:0.85rem;"
                        onclick="PendingPurchase.checkOnce(); if(typeof showToast==='function') showToast('ุฌุงุฑู ุงูุชุญุฏูุซ...','info');">
                        <i class="fas fa-sync-alt"></i> ุชุญุฏูุซ
                    </button>
                </div>
                <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">ุนูุฏ ููุงู ุงูุชุงุฌุฑ ุจุฅูุดุงุก ุทูุจ ุดุฑุงุก ุณุชุธูุฑ
                    ุงูุชูุงุตูู ููุง ูุชุฃููุฏูุง ุฃู ุฑูุถูุง.</p>

                <div id="noPendingState" style="text-align:center; padding:20px; color:#999;">
                    <i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
                    ูุง ุชูุฌุฏ ุทูุจุงุช ุดุฑุงุก ุญุงููุงู
                </div>

                <div id="pendingPurchaseCard"
                    style="display:none; background:linear-gradient(135deg, #fff9e6, #fff3cd); border:2px solid #f0ad4e; border-radius:16px; padding:24px; text-align:center;">
                    <p style="margin:0 0 5px; color:#856404; font-size:0.9rem;"><i class="fas fa-store"></i> ุทูุจ ุดุฑุงุก ูู
                        ุงูุชุงุฌุฑ</p>
                    <h4 id="pendingMerchant" style="color:#856404; margin:5px 0;">-</h4>

                    <div style="margin:15px 0;">
                        <p style="color:#666; font-size:0.85rem; margin:0;">ููุฏ ุงูุชุญูู</p>
                        <h1 id="pendingCode"
                            style="font-size:2.5rem; letter-spacing:12px; color:var(--brand-ink); margin:5px 0; font-family:monospace;">
                            ------</h1>
                    </div>

                    <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin:15px 0;">
                        <span><i class="fas fa-money-bill-wave" style="color:#8CC240;"></i> ุงููุจูุบ: <strong
                                id="pendingAmount" style="font-size:1.3rem; color:#8CC240;">0</strong> ุฑูุงู</span>
                        <span><i class="fas fa-clock" style="color:#e67e22;"></i> ููุชูู ุฎูุงู: <strong id="pendingTimer"
                                style="color:#e67e22;">5:00</strong></span>
                    </div>

                    <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                        <button onclick="PendingPurchase.confirm()"
                            style="background:#28a745; padding:12px 30px; font-size:1.1rem;">
                            <i class="fas fa-check-circle"></i> ุชุฃููุฏ ุงูุดุฑุงุก
                        </button>
                        <button onclick="PendingPurchase.reject()"
                            style="background:#dc3545; padding:12px 30px; font-size:1.1rem;">
                            <i class="fas fa-times-circle"></i> ุฑูุถ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Code Entry (Fallback) -->
        <div id="manualEntrySection" style="margin-top:20px; border-top:1px dashed #ccc; padding-top:15px;">
            <p style="margin:0 0 10px; color:#666; font-size:0.9rem;">
                <i class="fas fa-keyboard"></i> ูู ูุตูู ุงูุทูุจุ ุฃุฏุฎู ุงูููุฏ ุงูุฐู ูุธูุฑ ุนูุฏ ุงูุชุงุฌุฑ:
            </p>
            <div style="display:flex; gap:10px;">
                <input type="text" id="manualCodeInput" placeholder="ุฃุฏุฎู ุงูููุฏ (ูุซูุงู 123456)" maxlength="6"
                    style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; text-align:center; font-size:1.1rem; letter-spacing:2px;">
                <button onclick="PendingPurchase.manualCheck()"
                    style="padding:10px 20px; background:#6c757d; color:#fff; border:none; border-radius:8px;">
                    <i class="fas fa-search"></i> ุชุญูู
                </button>
            </div>
            <div style="margin-top:15px; text-align:center;">
                <button onclick="PendingPurchase.showDebugInfo()"
                    style="font-size:0.8rem; color:#999; background:none; border:none; text-decoration:underline;">
                    ๐ ูุงุฌูุช ูุดููุฉุ ุงุถุบุท ููุง ูููุญุต
                </button>
            </div>
        </div>

        <h3><i class="fas fa-history"></i> ุขุฎุฑ ุงูุนูููุงุช</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงููุชุฌุฑ</th>
                        <th>ุงููุจูุบ</th>
                    </tr>
                </thead>
                <tbody id="beneficiaryTransactionsTable"></tbody>
            </table>
        </div>

        <footer class="main-footer">
            <p>ุตูุน ูู ุชุฑุงุคู</p>
            <img src="assets/logo.png" alt="TRAOF Logo">
        </footer>
    </main>

    <script src="script.js?v=22"></script>
    <script>
        /* ===== Pending Purchase Requests (from merchant) ===== */
        const PendingPurchase = {
            pollInterval: null,
            currentRequest: null,
            timerInterval: null,

            startPolling: () => {
                PendingPurchase.checkOnce();
                if (PendingPurchase.pollInterval) clearInterval(PendingPurchase.pollInterval);
                PendingPurchase.pollInterval = setInterval(() => PendingPurchase.checkOnce(), 3000);
            },

            checkOnce: () => {
                const user = Auth.user;
                if (!user) return;
                const benefName = (user.linkedEntity || user.name).trim();

                const cards = Storage.get('cards') || [];
                const pending = Storage.get('pendingPurchases') || [];

                // Find my primary card identity
                const myIdentity = (user.username || '').trim();

                // Get my card numbers
                const myCardNumbers = cards
                    .filter(c => c.beneficiary === benefName || c.identity === myIdentity)
                    .map(c => c.number);

                // Find matching pending request
                const req = pending.find(p =>
                    p.status === 'pending' &&
                    Date.now() < p.expiresAt &&
                    (p.beneficiary === benefName || myCardNumbers.includes(p.cardNumber))
                );

                const noPendingEl = document.getElementById('noPendingState');
                const pendingCardEl = document.getElementById('pendingPurchaseCard');

                if (req) {
                    PendingPurchase.currentRequest = req;
                    if (noPendingEl) noPendingEl.style.display = 'none';
                    if (pendingCardEl) {
                        pendingCardEl.style.display = 'block';
                        document.getElementById('pendingMerchant').innerText = req.merchant || 'ุชุงุฌุฑ';
                        document.getElementById('pendingCode').innerText = req.code;
                        document.getElementById('pendingAmount').innerText = Number(req.amount).toFixed(2);
                    }
                    PendingPurchase.startTimer(req.expiresAt);
                } else {
                    PendingPurchase.currentRequest = null;
                    if (noPendingEl) noPendingEl.style.display = '';
                    if (pendingCardEl) pendingCardEl.style.display = 'none';
                }
            },

            startTimer: (expiresAt) => {
                if (PendingPurchase.timerInterval) clearInterval(PendingPurchase.timerInterval);
                const timerEl = document.getElementById('pendingTimer');
                PendingPurchase.timerInterval = setInterval(() => {
                    const remaining = expiresAt - Date.now();
                    if (remaining <= 0) {
                        clearInterval(PendingPurchase.timerInterval);
                        timerEl.innerText = 'ุงูุชูู!';
                        timerEl.style.color = '#c0392b';
                        PendingPurchase.checkOnce();
                        return;
                    }
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    timerEl.innerText = mins + ':' + String(secs).padStart(2, '0');
                }, 1000);
            },

            manualCheck: () => {
                const codeInput = document.getElementById('manualCodeInput');
                const code = codeInput.value.trim();
                if (!code || code.length !== 6) return alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุฏ ุตุญูุญ ูููู ูู 6 ุฃุฑูุงู');

                const pending = Storage.get('pendingPurchases') || [];
                const user = Auth.user;
                const benefName = user.linkedEntity || user.name;
                const cards = Storage.get('cards') || [];

                let myCards = [];
                if (/^\d+$/.test(user.username)) myCards.push(...cards.filter(c => c.identity === user.username));
                myCards.push(...cards.filter(c => c.beneficiary === benefName));
                myCards.push(...cards.filter(c => c.beneficiary && c.beneficiary.includes(benefName)));
                const myCardNumbers = [...new Set(myCards.map(c => c.number))];

                const req = pending.find(p => p.code === code && p.status === 'pending' &&
                    (p.beneficiary === benefName || myCardNumbers.includes(p.cardNumber))
                );

                if (req) {
                    PendingPurchase.currentRequest = req;
                    document.getElementById('noPendingState').style.display = 'none';
                    document.getElementById('pendingPurchaseCard').style.display = 'block';
                    document.getElementById('pendingMerchant').innerText = req.merchant || 'ุชุงุฌุฑ';
                    document.getElementById('pendingCode').innerText = req.code;
                    document.getElementById('pendingAmount').innerText = Number(req.amount).toFixed(2);
                    PendingPurchase.startTimer(req.expiresAt);
                    alert('โ ุชู ุงูุนุซูุฑ ุนูู ุงูุทูุจ! ููููู ุงูุขู ุชุฃููุฏู.');
                    codeInput.value = '';
                } else {
                    alert('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุทูุจ ุจูุฐุง ุงูููุฏ.');
                }
            },

            showDebugInfo: () => {
                const user = Auth.user;
                const cards = Storage.get('cards') || [];
                const pending = Storage.get('pendingPurchases') || [];
                const benefName = user.linkedEntity || user.name;
                const myCards = cards.filter(c => c.beneficiary && (c.beneficiary === benefName || c.beneficiary.includes(benefName)));

                const msg = `
๐ ูุนูููุงุช ุงูุชุดุฎูุต:
๐ค ุงููุณุชุฎุฏู: ${user.name} (${user.username})
๐ณ ุนุฏุฏ ุงูุจุทุงูุงุช: ${myCards.length}
๐ข ุฃุฑูุงู ุจุทุงูุงุชู: ${myCards.map(c => c.number).join(', ')}
๐จ ุทูุจุงุช ุงูุดุฑุงุก (ุงููู): ${pending.length}
๐ ุงูุฃููุงุฏ ุงููุชููุฑุฉ: ${pending.map(p => p.code).join(', ')}
`;
                alert(msg);
            },

            confirm: () => {
                const req = PendingPurchase.currentRequest;
                if (!req) return alert('ูุง ููุฌุฏ ุทูุจ ุดุฑุงุก ููุชุฃููุฏ');
                const cards = Storage.get('cards') || [];
                const card = cards.find(c => c.number === req.cardNumber);
                if (!card) return alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุจุทุงูุฉ');
                if (Number(card.balance) < req.amount) return alert('ุฑุตูุฏ ุงูุจุทุงูุฉ ุบูุฑ ูุงูู');

                const pending = Storage.get('pendingPurchases') || [];
                const p = pending.find(x => x.code === req.code);
                if (p) p.status = 'confirmed';
                Storage.set('pendingPurchases', pending);

                PendingPurchase.currentRequest = null;
                document.getElementById('pendingPurchaseCard').style.display = 'none';
                document.getElementById('noPendingState').style.display = '';

                alert('โ ุชู ุชุฃููุฏ ุทูุจ ุงูุดุฑุงุก!');
                if (typeof showToast === 'function') showToast('ุชู ุชุฃููุฏ ุทูุจ ุงูุดุฑุงุก!', 'success');
            },

            reject: () => {
                const req = PendingPurchase.currentRequest;
                if (!req) return;
                const pending = Storage.get('pendingPurchases') || [];
                const p = pending.find(x => x.code === req.code);
                if (p) p.status = 'rejected';
                Storage.set('pendingPurchases', pending);
                PendingPurchase.currentRequest = null;
                document.getElementById('pendingPurchaseCard').style.display = 'none';
                document.getElementById('noPendingState').style.display = '';
                alert('ุชู ุฑูุถ ุทูุจ ุงูุดุฑุงุก');
            }
        };

        function initBeneficiary() {
            const user = Auth.user;
            if (!user || user.role !== 'beneficiary') return;

            const welcome = document.getElementById('welcomeName');
            if (welcome) welcome.innerText = `ูุฑุญุจุงูุ ${user.name}`;

            const cards = Storage.get('cards') || [];
            const benefName = user.linkedEntity || user.name;

            let myCard = null;
            if (/^\d+$/.test(user.username)) {
                myCard = cards.find(c => c.identity === user.username && (c.status === 'ูุดุท' || c.status === 'Active'));
            }
            if (!myCard) {
                myCard = cards.find(c => c.beneficiary === benefName && (c.status === 'ูุดุท' || c.status === 'Active'));
            }
            if (!myCard) {
                myCard = cards.find(c => c.beneficiary && c.beneficiary.includes(benefName) && (c.status === 'ูุดุท' || c.status === 'Active'));
            }

            const cardSection = document.getElementById('cardDetailsSection');
            const noCard = document.getElementById('noCardState');

            if (myCard) {
                document.getElementById('cardNumberDisplay').innerText = myCard.number;
                document.getElementById('cardBalanceDisplay').innerText = Number(myCard.balance || 0).toFixed(2);

                const transactions = Storage.get('transactions') || [];
                const myTrans = transactions.filter(t => t.card === myCard.number);
                const tbody = document.getElementById('beneficiaryTransactionsTable');

                if (tbody) {
                    if (myTrans.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">ูุง ุชูุฌุฏ ุนูููุงุช ุณุงุจูุฉ</td></tr>';
                    } else {
                        tbody.innerHTML = myTrans.map(t => `
                            <tr>
                                <td>${t.date}</td>
                                <td>${t.merchant}</td>
                                <td style="color:red; font-weight:bold">-${Number(t.amount || 0).toFixed(2)} ุฑูุงู</td>
                            </tr>
                        `).join('');
                    }
                }
                if (cardSection) cardSection.style.display = '';
                if (noCard) noCard.style.display = 'none';
                renderBeneficiaryQR('qrBox', myCard.number);
            } else {
                if (cardSection) cardSection.style.display = 'none';
                if (noCard) noCard.style.display = 'block';
            }
            PendingPurchase.startPolling();
        }

        document.addEventListener('DOMContentLoaded', initBeneficiary);
    </script>
</body>

</html>