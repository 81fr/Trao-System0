<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>نقطة البيع - تراوف</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all-svg.css">

    <!-- PWA / Mobile App Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00A59B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="assets/logo.png" alt="TRAOF Logo" style="max-height:56px;">
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> لوحة التحكم</a></li>
            <li><a href="cards.html"><i class="fas fa-credit-card"></i> البطاقات</a></li>
            <li><a href="wallets.html"><i class="fas fa-wallet"></i> المحافظ</a></li>
            <li><a href="merchants.html"><i class="fas fa-store"></i> المتاجر</a></li>
            <li><a href="orders.html"><i class="fas fa-file-invoice-dollar"></i> أوامر التوريد</a></li>
            <li><a href="pos.html" class="active"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
            <li><a href="users.html"><i class="fas fa-users-cog"></i> المستخدمين</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
            <li><a href="support.html"><i class="fas fa-headset"></i> الدعم الفني</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header>
            <h1><i class="fas fa-cash-register"></i> نقطة البيع (POS)</h1>
            <div class="user-profile"><span>مرحباً</span>
                <div class="avatar">م</div>
            </div>
        </header>

        <div class="pos-layout">
            <!-- Main POS Area -->
            <div class="pos-main">
                <!-- Search & Filters -->
                <div style="display:flex; gap:12px; margin-bottom:10px;">
                    <div style="flex:1; position:relative;">
                        <i class="fas fa-search"
                            style="position:absolute; right:15px; top:12px; color:var(--muted)"></i>
                        <input type="text" id="posSearch" placeholder="بحث عن منتج..." style="padding-right:40px;"
                            oninput="POS.filterProducts()">
                    </div>
                </div>

                <!-- Categories -->
                <div class="pos-categories" id="posCategories">
                    <!-- Dynamic categories -->
                </div>

                <!-- Product Grid -->
                <div class="pos-grid" id="posProductGrid">
                    <!-- Dynamic products -->
                </div>
            </div>

            <!-- Sidebar / Cart Area -->
            <div class="pos-sidebar">
                <div class="cart-header">
                    <h3><i class="fas fa-shopping-basket"></i> السلة</h3>
                    <button class="secondary" style="padding:5px 10px;" onclick="POS.clearCart()">مسح</button>
                </div>

                <div class="cart-items" id="cartItems">
                    <!-- Dynamic cart items -->
                    <div style="text-align:center; margin-top:50px; color:var(--muted)">
                        <i class="fas fa-shopping-bag"
                            style="font-size:3rem; opacity:0.2; margin-bottom:10px; display:block;"></i>
                        السلة فارغة حالياً
                    </div>
                </div>

                <div class="cart-footer">
                    <div class="cart-total-row">
                        <span>المجموع الفرعي</span>
                        <span id="cartSubtotal">0.00 ر.س</span>
                    </div>
                    <div class="cart-total-row">
                        <span>الضريبة (15%)</span>
                        <span id="cartTax">0.00 ر.س</span>
                    </div>
                    <div class="cart-total-row grand-total">
                        <span>الإجمالي</span>
                        <span id="cartTotal">0.00 ر.س</span>
                    </div>

                    <button class="checkout-btn" onclick="POS.openCheckout()">
                        <i class="fas fa-credit-card"></i> إتمام العملية
                    </button>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            <p>صنع في تراؤف</p>
            <img src="assets/logo.png" alt="TRAOF Logo">
        </footer>
    </main>

    <!-- Modal for Checkout (Card Verification) -->
    <div id="checkoutModal" class="modal-backdrop">
        <div class="modal" style="max-width:450px;">
            <header>
                <strong><i class="fas fa-shield-alt"></i> إتمام العملية</strong>
                <button class="secondary" onclick="POS.closeCheckout()"><i class="fas fa-times"></i></button>
            </header>
            <div class="modal-body">
                <div id="checkoutSummary"
                    style="margin-bottom:20px; padding:15px; background:#f8fbfa; border-radius:12px; text-align:center;">
                    <div style="font-size:0.9rem; color:var(--muted)">إجمالي المبلغ المطلوب</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--brand-teal);" id="checkoutTotalVal">0.00
                        ر.س</div>
                </div>

                <div class="form-group">
                    <label>رقم البطاقة</label>
                    <input id="posCardNumber" type="text" placeholder="امسح البطاقة أو أدخل الرقم">
                </div>
                <button class="secondary" style="width:100%; margin-bottom:15px;" onclick="POS.verifyCardAction()">
                    <i class="fas fa-search"></i> تحقق من الرصيد
                </button>

                <div id="posCardStatus" style="margin-bottom:15px;"></div>

                <div id="posRequestArea" style="display:none; margin-bottom:15px; text-align:center;">
                    <button id="sendRequestBtn" style="width:100%; background:var(--brand-teal);"
                        onclick="POS.sendPurchaseRequest()">
                        <i class="fas fa-paper-plane"></i> إرسال طلب الشراء للمستفيد
                    </button>
                    <div id="posRequestStatus" style="margin-top:10px;"></div>
                </div>

                <div class="form-group">
                    <label>كود سري (تأكيد الشراء)</label>
                    <input id="posConfirmCode" type="text" placeholder="أدخل الكود الظاهر عند المستفيد" maxlength="6"
                        style="letter-spacing:10px; text-align:center; font-weight:bold; font-size:1.2rem;">
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="POS.closeCheckout()">إلغاء</button>
                <button onclick="POS.processCartPayment()">
                    <i class="fas fa-check"></i> تأكيد ودفع
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="posReceiptBackdrop" class="modal-backdrop">
        <div class="modal">
            <header>
                <strong><i class="fas fa-receipt"></i> إيصال العملية</strong>
                <button class="secondary" onclick="POS.closeModal()"><i class="fas fa-times"></i> إغلاق</button>
            </header>
            <div class="modal-body">
                <div id="receiptContent">جارٍ التحضير…</div>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="window.print()"><i class="fas fa-print"></i> طباعة / PDF</button>
                <button onclick="POS.closeModal()"><i class="fas fa-check"></i> تم</button>
            </div>
        </div>
    </div>

    <script src="script.js?v=21"></script>
    <script>
        // Initialize POS UI
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof POS !== 'undefined' && POS.init) {
                POS.init();
            }
        });

        // PWA Service Worker Register
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed!', err));
            });
        }
    </script>

</body>

</html>