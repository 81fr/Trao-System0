<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± - ØªØ±Ø§ÙˆÙ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all-svg.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* ===== Reports Premium Styles ===== */
        .report-hero {
            background: linear-gradient(135deg, #3E4559 0%, #00A59B 60%, #8CC240 100%);
            border-radius: 16px;
            padding: 28px 32px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .report-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -5%;
            width: 250px;
            height: 250px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .report-hero h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 4px;
            z-index: 1;
        }

        .report-hero p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9rem;
            z-index: 1;
        }

        .report-hero .hero-stats {
            display: flex;
            gap: 28px;
            z-index: 1;
        }

        .report-hero .h-stat {
            text-align: center;
        }

        .report-hero .h-stat .h-val {
            font-size: 1.6rem;
            font-weight: 800;
            display: block;
        }

        .report-hero .h-stat .h-lbl {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            border-radius: 14px;
            padding: 18px 22px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 14px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .filter-bar .fg {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-bar label {
            font-size: 0.75rem;
            color: #8c97a8;
            font-weight: 500;
        }

        .filter-bar input,
        .filter-bar select {
            border: 1.5px solid #e6ecf2;
            border-radius: 10px;
            padding: 9px 14px;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            color: #3E4559;
            outline: none;
            transition: border-color 0.2s;
        }

        .filter-bar input:focus,
        .filter-bar select:focus {
            border-color: #00A59B;
        }

        .filter-bar .btn-filter {
            padding: 9px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00A59B, #8CC240);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 165, 155, 0.3);
        }

        .btn-outline {
            background: white;
            color: #3E4559;
            border: 1.5px solid #e6ecf2 !important;
        }

        .btn-outline:hover {
            border-color: #00A59B !important;
            color: #00A59B;
        }

        .btn-danger {
            background: #fef2f2;
            color: #dc2626;
        }

        .btn-danger:hover {
            background: #dc2626;
            color: white;
        }

        /* Summary Cards */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 24px;
        }

        .sum-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            display: flex;
            align-items: center;
            gap: 14px;
            border-right: 4px solid transparent;
            transition: transform 0.2s;
        }

        .sum-card:hover {
            transform: translateY(-3px);
        }

        .sum-card.bdr-teal {
            border-right-color: #00A59B;
        }

        .sum-card.bdr-green {
            border-right-color: #8CC240;
        }

        .sum-card.bdr-orange {
            border-right-color: #f59e0b;
        }

        .sum-card.bdr-purple {
            border-right-color: #8b5cf6;
        }

        .sum-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            color: white;
        }

        .sum-icon.teal {
            background: linear-gradient(135deg, #00A59B, #008f87);
        }

        .sum-icon.green {
            background: linear-gradient(135deg, #8CC240, #6fa830);
        }

        .sum-icon.orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .sum-icon.purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .sum-info h4 {
            margin: 0;
            font-size: 0.72rem;
            color: #8c97a8;
            font-weight: 400;
        }

        .sum-info .sum-val {
            font-size: 1.4rem;
            font-weight: 800;
            color: #3E4559;
        }

        /* Charts Grid */
        .charts-grid-2 {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 18px;
            margin-bottom: 24px;
        }

        .charts-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 18px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.05);
        }

        .chart-card h3 {
            margin: 0 0 14px;
            font-size: 0.92rem;
            color: #3E4559;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-card h3 i {
            color: #00A59B;
            font-size: 0.85rem;
        }

        /* Transaction Table */
        .table-card {
            background: white;
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .table-card h3 {
            margin: 0 0 16px;
            font-size: 0.95rem;
            color: #3E4559;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-card h3 .badge {
            background: #e7f7f6;
            color: #00A59B;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.72rem;
        }

        .rpt-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rpt-table th {
            text-align: right;
            padding: 10px 10px;
            font-size: 0.75rem;
            color: #8c97a8;
            border-bottom: 2px solid #f0f0f0;
            font-weight: 600;
            background: #fafbfc;
        }

        .rpt-table td {
            padding: 10px;
            font-size: 0.84rem;
            border-bottom: 1px solid #f5f5f5;
        }

        .rpt-table tr:hover td {
            background: #f9fafb;
        }

        .rpt-table tr:last-child td {
            border: none;
        }

        /* Search Box */
        .search-box {
            border: 1.5px solid #e6ecf2;
            border-radius: 10px;
            padding: 8px 14px;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            width: 260px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-box:focus {
            border-color: #00A59B;
        }

        /* Pagination */
        .pager {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
            margin-top: 16px;
        }

        .pager button {
            width: 34px;
            height: 34px;
            border: 1.5px solid #e6ecf2;
            border-radius: 8px;
            background: white;
            color: #3E4559;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.82rem;
            transition: all 0.2s;
        }

        .pager button:hover {
            border-color: #00A59B;
            color: #00A59B;
        }

        .pager button.active-page {
            background: linear-gradient(135deg, #00A59B, #8CC240);
            color: white;
            border: none;
        }

        .pager span {
            font-size: 0.8rem;
            color: #8c97a8;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease forwards;
            opacity: 0;
        }

        .fade-in:nth-child(1) {
            animation-delay: 0.03s;
        }

        .fade-in:nth-child(2) {
            animation-delay: 0.06s;
        }

        .fade-in:nth-child(3) {
            animation-delay: 0.09s;
        }

        .fade-in:nth-child(4) {
            animation-delay: 0.12s;
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .charts-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .charts-grid-2 {
                grid-template-columns: 1fr;
            }

            .report-hero {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .report-hero .hero-stats {
                justify-content: center;
            }

            .filter-bar {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="assets/logo.png" alt="TRAOF Logo" style="max-height:56px;">
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
            <li><a href="cards.html"><i class="fas fa-credit-card"></i> Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</a></li>
            <li><a href="wallets.html"><i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø­Ø§ÙØ¸</a></li>
            <li><a href="merchants.html"><i class="fas fa-store"></i> Ø§Ù„Ù…ØªØ§Ø¬Ø±</a></li>
            <li><a href="orders.html"><i class="fas fa-file-invoice-dollar"></i> Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</a></li>
            <li><a href="pos.html"><i class="fas fa-cash-register"></i> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</a></li>
            <li><a href="reports.html" class="active"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
            <li><a href="users.html"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
            <li><a href="monitor.html"><i class="fas fa-stethoscope"></i> ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…</a></li>
            <li><a href="support.html"><i class="fas fa-headset"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header>
            <h1><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h1>
            <div class="user-profile"><span>Ù…Ø±Ø­Ø¨Ø§Ù‹</span>
                <div class="avatar">Ù…</div>
            </div>
        </header>

        <!-- Hero -->
        <div class="report-hero fade-in">
            <div>
                <h2><i class="fas fa-chart-line"></i> Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                <p>ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            </div>
            <div class="hero-stats">
                <div class="h-stat"><span class="h-val" id="heroTxCount">0</span><span class="h-lbl">Ø¹Ù…Ù„ÙŠØ©</span></div>
                <div class="h-stat"><span class="h-val" id="heroTxTotal">0</span><span class="h-lbl">Ø±.Ø³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                </div>
                <div class="h-stat"><span class="h-val" id="heroAvg">0</span><span class="h-lbl">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar fade-in">
            <div class="fg">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="fromDate">
            </div>
            <div class="fg">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="toDate">
            </div>
            <div class="fg">
                <label>Ø§Ù„Ù…ØªØ¬Ø±</label>
                <select id="filterMerchant">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                </select>
            </div>
            <div class="fg">
                <label>Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
                <select id="filterWallet">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                </select>
            </div>
            <button class="btn-filter btn-primary" onclick="applyFilters()"><i class="fas fa-filter"></i> ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="btn-filter btn-outline" onclick="resetFilters()"><i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø©</button>
            <button class="btn-filter btn-outline" onclick="exportCSV()"><i class="fas fa-file-excel"></i>
                Excel</button>
            <button class="btn-filter btn-outline" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>

        <!-- Summary Cards -->
        <div class="summary-row">
            <div class="sum-card bdr-teal fade-in">
                <div class="sum-icon teal"><i class="fas fa-receipt"></i></div>
                <div class="sum-info">
                    <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
                    <div class="sum-val" id="sumCount">0</div>
                </div>
            </div>
            <div class="sum-card bdr-green fade-in">
                <div class="sum-icon green"><i class="fas fa-coins"></i></div>
                <div class="sum-info">
                    <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h4>
                    <div class="sum-val" id="sumTotal">0 Ø±.Ø³</div>
                </div>
            </div>
            <div class="sum-card bdr-orange fade-in">
                <div class="sum-icon orange"><i class="fas fa-calculator"></i></div>
                <div class="sum-info">
                    <h4>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h4>
                    <div class="sum-val" id="sumAvg">0 Ø±.Ø³</div>
                </div>
            </div>
            <div class="sum-card bdr-purple fade-in">
                <div class="sum-icon purple"><i class="fas fa-arrow-up"></i></div>
                <div class="sum-info">
                    <h4>Ø£Ø¹Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ©</h4>
                    <div class="sum-val" id="sumMax">0 Ø±.Ø³</div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="charts-grid-2">
            <div class="chart-card fade-in">
                <h3><i class="fas fa-chart-area"></i> Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                <div style="height:260px; position:relative;"><canvas id="dailyChart"></canvas></div>
            </div>
            <div class="chart-card fade-in">
                <h3><i class="fas fa-chart-pie"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¬Ø±</h3>
                <div style="height:260px; position:relative;"><canvas id="merchantPie"></canvas></div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="charts-grid-3">
            <div class="chart-card fade-in">
                <h3><i class="fas fa-chart-bar"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„ÙƒÙ„ Ù…ØªØ¬Ø±</h3>
                <div style="height:240px; position:relative;"><canvas id="merchantCountChart"></canvas></div>
            </div>
            <div class="chart-card fade-in">
                <h3><i class="fas fa-credit-card"></i> Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØµØ±ÙØ§Ù‹</h3>
                <div style="height:240px; position:relative;"><canvas id="topCardsChart"></canvas></div>
            </div>
            <div class="chart-card fade-in">
                <h3><i class="fas fa-wallet"></i> Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
                <div style="height:240px; position:relative;"><canvas id="walletSpendChart"></canvas></div>
            </div>
        </div>

        <!-- Transaction Table -->
        <div class="table-card fade-in">
            <h3>
                <span><i class="fas fa-list" style="color:#00A59B; margin-inline-end:8px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                    Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</span>
                <span style="display:flex; align-items:center; gap:10px;">
                    <span class="badge" id="tableBadge">0 Ø¹Ù…Ù„ÙŠØ©</span>
                    <input class="search-box" id="txSearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…ØªØ¬Ø± Ø£Ùˆ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...">
                </span>
            </h3>
            <table class="rpt-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ù…ØªØ¬Ø±</th>
                        <th>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                        <th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    </tr>
                </thead>
                <tbody id="txBody"></tbody>
            </table>
            <div class="pager" id="txPager"></div>
        </div>

        <footer class="main-footer">
            <p>ØµÙ†Ø¹ ÙÙŠ ØªØ±Ø§Ø¤Ù</p>
            <img src="assets/logo.png" alt="TRAOF Logo">
        </footer>
    </main>

    <script src="script.js?v=6"></script>
    <script>
        /* ===========================
           REPORTS ENGINE
        =========================== */
        const BRAND = { teal: '#00A59B', green: '#8CC240', ink: '#3E4559', orange: '#f59e0b', purple: '#8b5cf6', red: '#ef4444' };
        const COLORS = [BRAND.teal, BRAND.green, BRAND.ink, BRAND.orange, BRAND.purple, BRAND.red, '#06b6d4', '#ec4899', '#14b8a6', '#a855f7'];

        let allTransactions = [];
        let filteredTx = [];
        let currentPage = 1;
        const PER_PAGE = 12;
        let chartInstances = {};

        // --- Init ---
        function initReports() {
            allTransactions = Storage.get('transactions') || [];
            filteredTx = [...allTransactions];
            populateFilterDropdowns();
            updateAll();
        }

        // --- Populate filter dropdowns ---
        function populateFilterDropdowns() {
            const merchants = Storage.get('merchants') || [];
            const wallets = Storage.get('wallets') || [];
            const mSel = document.getElementById('filterMerchant');
            const wSel = document.getElementById('filterWallet');
            merchants.forEach(m => { const o = document.createElement('option'); o.value = m.name; o.textContent = m.name; mSel.appendChild(o); });
            wallets.forEach(w => { const o = document.createElement('option'); o.value = w.name; o.textContent = w.name; wSel.appendChild(o); });
        }

        // --- Apply Filters ---
        function applyFilters() {
            const merchant = document.getElementById('filterMerchant').value;
            const wallet = document.getElementById('filterWallet').value;

            filteredTx = allTransactions.filter(t => {
                if (merchant && t.merchant !== merchant) return false;
                if (wallet) {
                    const cards = Storage.get('cards') || [];
                    const walletCards = cards.filter(c => c.wallet === wallet).map(c => c.number);
                    if (!walletCards.includes(t.card)) return false;
                }
                return true;
            });

            currentPage = 1;
            updateAll();
        }

        function resetFilters() {
            document.getElementById('filterMerchant').value = '';
            document.getElementById('filterWallet').value = '';
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            document.getElementById('txSearch').value = '';
            filteredTx = [...allTransactions];
            currentPage = 1;
            updateAll();
        }

        // --- Update Everything ---
        function updateAll() {
            updateHero();
            updateSummary();
            buildDailyChart();
            buildMerchantPie();
            buildMerchantCountChart();
            buildTopCardsChart();
            buildWalletSpendChart();
            renderTable();
        }

        // --- Hero Stats ---
        function updateHero() {
            const total = filteredTx.reduce((s, t) => s + Number(t.amount || 0), 0);
            const avg = filteredTx.length ? Math.round(total / filteredTx.length) : 0;
            document.getElementById('heroTxCount').textContent = filteredTx.length.toLocaleString('ar-SA');
            document.getElementById('heroTxTotal').textContent = total.toLocaleString('ar-SA');
            document.getElementById('heroAvg').textContent = avg.toLocaleString('ar-SA');
        }

        // --- Summary Cards ---
        function updateSummary() {
            const total = filteredTx.reduce((s, t) => s + Number(t.amount || 0), 0);
            const avg = filteredTx.length ? Math.round(total / filteredTx.length) : 0;
            const max = filteredTx.length ? Math.max(...filteredTx.map(t => Number(t.amount || 0))) : 0;
            document.getElementById('sumCount').textContent = filteredTx.length.toLocaleString('ar-SA');
            document.getElementById('sumTotal').textContent = total.toLocaleString('ar-SA') + ' Ø±.Ø³';
            document.getElementById('sumAvg').textContent = avg.toLocaleString('ar-SA') + ' Ø±.Ø³';
            document.getElementById('sumMax').textContent = max.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        // --- Chart Helpers ---
        function destroyChart(key) { if (chartInstances[key]) { chartInstances[key].destroy(); } }

        // Chart 1: Daily Sales (Area Line)
        function buildDailyChart() {
            destroyChart('daily');
            const el = document.getElementById('dailyChart');
            if (!el || typeof Chart === 'undefined') return;

            const dailyMap = {};
            filteredTx.forEach(t => { dailyMap[t.date] = (dailyMap[t.date] || 0) + Number(t.amount || 0); });

            const now = new Date();
            const labels = [], data = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date(now); d.setDate(now.getDate() - i);
                const key = d.toLocaleDateString('ar-SA');
                labels.push(d.toLocaleDateString('ar-SA', { day: 'numeric', month: 'numeric' }));
                data.push(dailyMap[key] || 0);
            }

            chartInstances['daily'] = new Chart(el.getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø±.Ø³)',
                        data,
                        borderColor: BRAND.teal,
                        backgroundColor: 'rgba(0,165,155,0.12)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2.5,
                        pointRadius: 2,
                        pointHoverRadius: 6,
                        pointBackgroundColor: BRAND.teal
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 9 } } }
                    }
                }
            });
        }

        // Chart 2: Merchant Pie
        function buildMerchantPie() {
            destroyChart('mpie');
            const el = document.getElementById('merchantPie');
            if (!el || typeof Chart === 'undefined') return;

            const mMap = {};
            filteredTx.forEach(t => { mMap[t.merchant] = (mMap[t.merchant] || 0) + Number(t.amount || 0); });
            const sorted = Object.entries(mMap).sort((a, b) => b[1] - a[1]);

            chartInstances['mpie'] = new Chart(el.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{ data: sorted.map(s => s[1]), backgroundColor: COLORS.slice(0, sorted.length), borderWidth: 0, hoverOffset: 6 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '58%',
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { family: 'Tajawal', size: 10 } } } }
                }
            });
        }

        // Chart 3: Merchant Transaction Count (Bar)
        function buildMerchantCountChart() {
            destroyChart('mcount');
            const el = document.getElementById('merchantCountChart');
            if (!el || typeof Chart === 'undefined') return;

            const mMap = {};
            filteredTx.forEach(t => { mMap[t.merchant] = (mMap[t.merchant] || 0) + 1; });
            const sorted = Object.entries(mMap).sort((a, b) => b[1] - a[1]).slice(0, 8);

            chartInstances['mcount'] = new Chart(el.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', data: sorted.map(s => s[1]), backgroundColor: COLORS.slice(0, sorted.length), borderRadius: 6, borderSkipped: false }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, grid: { color: '#f0f0f0' } }, y: { grid: { display: false }, ticks: { font: { family: 'Tajawal', size: 10 } } } }
                }
            });
        }

        // Chart 4: Top Cards Spending (Bar)
        function buildTopCardsChart() {
            destroyChart('tcards');
            const el = document.getElementById('topCardsChart');
            if (!el || typeof Chart === 'undefined') return;

            const cardMap = {};
            filteredTx.forEach(t => { cardMap[t.card] = (cardMap[t.card] || 0) + Number(t.amount || 0); });
            const sorted = Object.entries(cardMap).sort((a, b) => b[1] - a[1]).slice(0, 6);

            // Lookup beneficiary names
            const cards = Storage.get('cards') || [];
            const labels = sorted.map(s => {
                const c = cards.find(c => c.number === s[0]);
                return c ? (c.beneficiary || '').split(' ').slice(0, 2).join(' ') : s[0];
            });

            chartInstances['tcards'] = new Chart(el.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ±Ù', data: sorted.map(s => s[1]), backgroundColor: BRAND.green + 'cc', borderRadius: 6, borderSkipped: false }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' } }, x: { grid: { display: false }, ticks: { font: { family: 'Tajawal', size: 10 } } } }
                }
            });
        }

        // Chart 5: Wallet Spend (Polar)
        function buildWalletSpendChart() {
            destroyChart('wspend');
            const el = document.getElementById('walletSpendChart');
            if (!el || typeof Chart === 'undefined') return;

            const cards = Storage.get('cards') || [];
            const wallets = Storage.get('wallets') || [];
            const walletMap = {};
            wallets.forEach(w => { walletMap[w.name] = 0; });

            filteredTx.forEach(t => {
                const card = cards.find(c => c.number === t.card);
                if (card && walletMap.hasOwnProperty(card.wallet)) {
                    walletMap[card.wallet] += Number(t.amount || 0);
                }
            });

            const entries = Object.entries(walletMap).filter(e => e[1] > 0).sort((a, b) => b[1] - a[1]);

            chartInstances['wspend'] = new Chart(el.getContext('2d'), {
                type: 'polarArea',
                data: {
                    labels: entries.map(e => e[0]),
                    datasets: [{ data: entries.map(e => e[1]), backgroundColor: COLORS.slice(0, entries.length).map(c => c + 'bb'), borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { family: 'Tajawal', size: 10 } } } },
                    scales: { r: { display: false } }
                }
            });
        }

        // --- Transaction Table with Search & Pagination ---
        function renderTable() {
            const search = (document.getElementById('txSearch').value || '').trim().toLowerCase();
            let data = filteredTx;
            if (search) {
                data = data.filter(t => t.merchant.toLowerCase().includes(search) || t.card.includes(search));
            }

            const totalPages = Math.ceil(data.length / PER_PAGE) || 1;
            if (currentPage > totalPages) currentPage = totalPages;

            const start = (currentPage - 1) * PER_PAGE;
            const page = data.slice(start, start + PER_PAGE);

            const cards = Storage.get('cards') || [];
            const tbody = document.getElementById('txBody');
            document.getElementById('tableBadge').textContent = data.length + ' Ø¹Ù…Ù„ÙŠØ©';

            if (page.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#aaa; padding:30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
            } else {
                tbody.innerHTML = page.map((t, i) => {
                    const card = cards.find(c => c.number === t.card);
                    const benName = card ? (card.beneficiary || '').split(' ').slice(0, 2).join(' ') : '-';
                    return `<tr>
                    <td style="color:#8c97a8; font-size:0.75rem">${start + i + 1}</td>
                    <td style="font-weight:500">${t.merchant}</td>
                    <td style="font-family:monospace; font-size:0.8rem">${t.card}</td>
                    <td>${benName}</td>
                    <td style="font-weight:700; color:#00A59B">${Number(t.amount).toLocaleString('ar-SA')}</td>
                    <td style="color:#8c97a8; font-size:0.78rem">${t.date}</td>
                </tr>`;
                }).join('');
            }

            // Pagination
            const pager = document.getElementById('txPager');
            if (totalPages <= 1) { pager.innerHTML = ''; return; }

            let html = `<button onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-angle-double-right"></i></button>`;
            html += `<button onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-angle-right"></i></button>`;

            const maxButtons = 5;
            let startP = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endP = Math.min(totalPages, startP + maxButtons - 1);
            if (endP - startP < maxButtons - 1) startP = Math.max(1, endP - maxButtons + 1);

            for (let p = startP; p <= endP; p++) {
                html += `<button class="${p === currentPage ? 'active-page' : ''}" onclick="goPage(${p})">${p}</button>`;
            }

            html += `<button onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-angle-left"></i></button>`;
            html += `<button onclick="goPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-angle-double-left"></i></button>`;
            html += `<span>ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages}</span>`;
            pager.innerHTML = html;
        }

        function goPage(p) {
            const totalPages = Math.ceil(filteredTx.length / PER_PAGE) || 1;
            if (p < 1 || p > totalPages) return;
            currentPage = p;
            renderTable();
        }

        // --- Search live ---
        document.getElementById('txSearch').addEventListener('input', () => { currentPage = 1; renderTable(); });

        // --- Export CSV ---
        function exportCSV() {
            if (filteredTx.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
            const cards = Storage.get('cards') || [];
            let csv = '\uFEFF#,Ø§Ù„Ù…ØªØ¬Ø±,Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©,Ø§Ù„Ù…Ø³ØªÙÙŠØ¯,Ø§Ù„Ù…Ø¨Ù„Øº,Ø§Ù„ØªØ§Ø±ÙŠØ®\n';
            filteredTx.forEach((t, i) => {
                const card = cards.find(c => c.number === t.card);
                const ben = card ? card.beneficiary : '-';
                csv += `${i + 1},${t.merchant},${t.card},${ben},${t.amount},${t.date}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª_' + new Date().toLocaleDateString('ar-SA') + '.csv';
            link.click();
        }

        // --- Export PDF (simple print) ---
        function exportPDF() {
            window.print();
        }

        // --- Init on load ---
        const _origOnload = window.onload;
        window.onload = function () {
            if (_origOnload) _origOnload();
            setTimeout(initReports, 100);
        };
    </script>
</body>

</html>