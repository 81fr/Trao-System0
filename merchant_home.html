<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    
    <title>ููุญุฉ ุงูุชุงุฌุฑ - ุชุฑุงูู</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all-svg.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- PWA / Mobile App Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00A59B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="assets/logo.png" alt=""></div>
        <ul class="nav-links">
            <li><a href="merchant_home.html" class="active"><i class="fas fa-store"></i> ููุญุฉ ุงูุชุงุฌุฑ</a></li>
            <li><a href="pos.html"><i class="fas fa-cash-register"></i> ููุทุฉ ุงูุจูุน</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> ุงูุชูุงุฑูุฑ</a></li>
            <li><a href="support.html"><i class="fas fa-headset"></i> ุงูุฏุนู ุงูููู</a></li>
            <li><a href="#" onclick="Auth.logout()"><i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุฎุฑูุฌ</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header>
            <h1><i class="fas fa-store"></i> ูุฑุญุจุงู ุจุงูุชุงุฌุฑ</h1>
            <div class="user-profile"><span>ูุฑุญุจุงู</span>
                <div class="avatar">ุช</div>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="icon"><i class="fas fa-exchange-alt"></i></div>
                <h3>ุนุฏุฏ ุงูุนูููุงุช</h3>
                <div class="value" id="merchantTxCount">0</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-wallet"></i></div>
                <h3>ูุจูุนุงุช ุงูููู</h3>
                <div class="value" id="merchantToday">0</div>
            </div>
        </div>

        <!-- ===== QR Scanner Section ===== -->
        <div class="form-container" style="border-top: 4px solid var(--brand-teal);">
            <h3><i class="fas fa-qrcode"></i> ูุณุญ ุจุทุงูุฉ ุงููุณุชููุฏ</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">ุงูุชุญ ุงููุงููุฑุง ููุณุญ ุฑูุฒ QR ุงูุฎุงุต ุจุจุทุงูุฉ
                ุงููุณุชููุฏุ ุฃู ุฃุฏุฎู ุงูุฑูู ูุฏููุงู.</p>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-bottom:15px;">
                <div class="form-group" style="flex:1; min-width:200px; margin-bottom:0;">
                    <label>ุฑูู ุงูุจุทุงูุฉ</label>
                    <input id="scanCardNumber" type="text" placeholder="ุฃุฏุฎู ุฑูู ุงูุจุทุงูุฉ ุฃู ุฑูู ุงููููุฉ">
                </div>
                <button onclick="MerchantScanner.lookupCard()" style="white-space:nowrap;">
                    <i class="fas fa-search"></i> ุจุญุซ
                </button>
                <button id="btnStartScan" onclick="MerchantScanner.startScan()"
                    style="background:var(--brand-teal); white-space:nowrap;">
                    <i class="fas fa-camera"></i> ูุชุญ ุงููุงููุฑุง
                </button>
                <button id="btnStopScan" onclick="MerchantScanner.stopScan()"
                    style="background:#dc3545; display:none; white-space:nowrap;">
                    <i class="fas fa-times"></i> ุฅุบูุงู ุงููุงููุฑุง
                </button>
            </div>

            <!-- Camera Preview -->
            <div id="qr-reader"
                style="display:none; max-width:400px; margin:0 auto 15px; border-radius:12px; overflow:hidden; border:2px solid var(--brand-teal);">
            </div>

            <!-- Scan Result Card -->
            <div id="scanResult"
                style="display:none; background:#f0faf9; border:1px solid #c9e8e5; border-radius:12px; padding:16px;">
                <h4 style="margin:0 0 10px; color:var(--brand-teal);"><i class="fas fa-id-card"></i> ุจูุงูุงุช ุงูุจุทุงูุฉ</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><strong>ุฑูู ุงูุจุทุงูุฉ:</strong> <span id="resultCardNum">-</span></div>
                    <div><strong>ุงููุณุชููุฏ:</strong> <span id="resultBeneficiary">-</span></div>
                    <div><strong>ุฑูู ุงููููุฉ:</strong> <span id="resultIdentity">-</span></div>
                    <div><strong>ุงููุญูุธุฉ:</strong> <span id="resultWallet">-</span></div>
                    <div><strong>ุงูุฑุตูุฏ:</strong> <span id="resultBalance"
                            style="color:var(--brand-teal); font-weight:bold;">-</span></div>
                    <div><strong>ุงูุญุงูุฉ:</strong> <span id="resultStatus">-</span></div>
                </div>

                <!-- ===== ุฅูุดุงุก ุทูุจ ุดุฑุงุก ===== -->
                <div style="margin-top:15px; border-top:2px dashed #c9e8e5; padding-top:15px;">
                    <h4 style="margin:0 0 10px; color:#8CC240;"><i class="fas fa-shopping-cart"></i> ุฅูุดุงุก ุทูุจ ุดุฑุงุก</h4>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                        <div class="form-group" style="flex:1; min-width:150px; margin-bottom:0;">
                            <label>ุงููุจูุบ (ุฑูุงู)</label>
                            <input id="purchaseAmount" type="number" min="1" placeholder="ุฃุฏุฎู ูุจูุบ ุงูุดุฑุงุก">
                        </div>
                        <button onclick="MerchantScanner.createPurchaseRequest()"
                            style="background:#8CC240; white-space:nowrap;">
                            <i class="fas fa-paper-plane"></i> ุฅุฑุณุงู ุทูุจ ุงูุดุฑุงุก
                        </button>
                    </div>
                </div>

                <!-- ูุชูุฌุฉ ุงูุทูุจ -->
                <div id="purchaseRequestResult"
                    style="display:none; margin-top:15px; text-align:center; background:linear-gradient(135deg, #fff9e6, #fff3cd); border:2px solid #f0ad4e; border-radius:12px; padding:20px;">
                    <p style="margin:0 0 5px; color:#856404; font-size:0.9rem;"><i class="fas fa-hourglass-half"></i>
                        ุจุงูุชุธุงุฑ ุชุฃููุฏ ุงููุณุชููุฏ</p>
                    <h2 id="merchantCode"
                        style="font-size:3rem; letter-spacing:15px; color:#856404; margin:15px 0; font-family:monospace; font-weight:bold;">
                        ------</h2>
                    <p style="margin:0 0 8px; color:#666;">ุงููุจูุบ: <strong id="merchantReqAmount">0</strong> ุฑูุงู</p>
                    <p style="font-size:0.85rem; color:#888;">ุงูููุฏ ุธุงูุฑ ุงูุขู ุนูุฏ ุงููุณุชููุฏ ูุชุฃููุฏ ุงูุนูููุฉ</p>
                    <div style="margin-top:10px;">
                        <span id="merchantReqStatus"
                            style="background:#f0ad4e; color:#fff; padding:5px 15px; border-radius:20px; font-size:0.85rem;">โณ
                            ุจุงูุชุธุงุฑ ุงูุชุฃููุฏ</span>
                    </div>
                </div>

                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button onclick="MerchantScanner.goToPOS()" style="flex:1;">
                        <i class="fas fa-cash-register"></i> ุงูุงูุชูุงู ูููุทุฉ ุงูุจูุน
                    </button>
                    <button class="secondary" onclick="MerchantScanner.clearResult()">
                        <i class="fas fa-redo"></i> ูุณุญ ุฌุฏูุฏ
                    </button>
                </div>

                <div style="margin-top:15px; text-align:center;">
                    <button onclick="MerchantScanner.showDebugInfo()"
                        style="font-size:0.8rem; color:#999; background:none; border:none; text-decoration:underline;">
                        ๐ ูุญุต ุญุงูุฉ ุงููุธุงู
                    </button>
                </div>
            </div>
        </div>

        <h3 style="margin-top:24px;">ุฃูุงูุฑ ุงูุชูุฑูุฏ ุงููุงุฑุฏุฉ</h3>
        <div class="table-container" style="margin-bottom:24px;">
            <table>
                <thead>
                    <tr>
                        <th>ุฑูู ุงูุฃูุฑ</th>
                        <th>ุงูุตูู / ุงูุฎุฏูุฉ</th>
                        <th>ุงููููุฉ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุญุงูุฉ</th>
                        <th>ุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody id="merchantOrdersTable"></tbody>
            </table>
        </div>

        <h3>ุขุฎุฑ ุงูุนูููุงุช</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ุงูุจุทุงูุฉ</th>
                        <th>ุงููุจูุบ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                    </tr>
                </thead>
                <tbody id="merchantTxTable"></tbody>
            </table>
        </div>
        <footer class="main-footer">
            <p>ุตูุน ูู ุชุฑุงุคู</p>
            <img src="assets/logo.png" alt="TRAOF Logo">
        </footer>
    </main>

    <script src="script.js"></script>
    <script>
        /* ===== QR Scanner Logic ===== */
        const MerchantScanner = {
            scanner: null,
            scannedCard: null,

            startScan: () => {
                const readerDiv = document.getElementById('qr-reader');
                readerDiv.style.display = 'block';
                document.getElementById('btnStartScan').style.display = 'none';
                document.getElementById('btnStopScan').style.display = '';

                MerchantScanner.scanner = new Html5Qrcode('qr-reader');
                MerchantScanner.scanner.start(
                    { facingMode: 'environment' },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        document.getElementById('scanCardNumber').value = decodedText;
                        MerchantScanner.stopScan();
                        MerchantScanner.lookupCard();
                        if (typeof showToast === 'function') showToast('ุชู ูุณุญ ุงูููุฏ ุจูุฌุงุญ!', 'success');
                    },
                    (errorMessage) => {
                        // Ignore scan errors (normal during scanning)
                    }
                ).catch(err => {
                    alert('ุชุนุฐุฑ ูุชุญ ุงููุงููุฑุง. ุชุฃูุฏ ูู ููุญ ุตูุงุญูุฉ ุงููุงููุฑุง.');
                    MerchantScanner.stopScan();
                });
            },

            stopScan: () => {
                if (MerchantScanner.scanner) {
                    MerchantScanner.scanner.stop().then(() => {
                        MerchantScanner.scanner.clear();
                    }).catch(() => { });
                }
                document.getElementById('qr-reader').style.display = 'none';
                document.getElementById('btnStartScan').style.display = '';
                document.getElementById('btnStopScan').style.display = 'none';
            },

            lookupCard: () => {
                const input = document.getElementById('scanCardNumber').value.trim();
                if (!input) return alert('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุจุทุงูุฉ ุฃู ุฑูู ุงููููุฉ ุฃู ูุณุญ QR ุฃููุงู');

                const cards = Storage.get('cards') || [];
                const beneficiaries = Storage.get('beneficiaries') || [];

                console.log('Scanner input:', input);
                console.log('Available cards:', cards.map(c => c.number));

                // Search by exact card number
                let card = cards.find(c => c.number === input);

                // Search by identity number
                if (!card) card = cards.find(c => c.identity === input);

                // Search by beneficiary name
                if (!card) card = cards.find(c => c.beneficiary === input);

                // Try partial match (contains)
                if (!card) card = cards.find(c => c.number && c.number.includes(input));
                if (!card) card = cards.find(c => c.identity && c.identity.includes(input));

                // Try matching via beneficiaries table (identity -> name -> card)
                if (!card) {
                    const ben = beneficiaries.find(b => b.identity === input || b.name === input);
                    if (ben) {
                        card = cards.find(c => c.beneficiary === ben.name);
                    }
                }

                if (!card) {
                    document.getElementById('scanResult').style.display = 'none';
                    const available = cards.map(c => c.number).join(', ');
                    return alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุจุทุงูุฉ.\nุงููููุฉ ุงูููุณูุญุฉ: ' + input + '\nุงูุจุทุงูุงุช ุงููุชููุฑุฉ: ' + (available || 'ูุง ุชูุฌุฏ ุจุทุงูุงุช'));
                }

                MerchantScanner.scannedCard = card;

                document.getElementById('resultCardNum').innerText = card.number;
                document.getElementById('resultBeneficiary').innerText = card.beneficiary || 'ุบูุฑ ูุญุฏุฏ';
                document.getElementById('resultWallet').innerText = card.wallet || '-';
                document.getElementById('resultBalance').innerText = Number(card.balance || 0).toFixed(2) + ' ุฑูุงู';
                document.getElementById('resultIdentity').innerText = card.identity || '-';

                const statusText = (card.status === 'ูุดุท' || card.status === 'Active') ? 'ูุดุท โ' : 'ููููู โ';
                document.getElementById('resultStatus').innerText = statusText;

                document.getElementById('scanResult').style.display = 'block';
            },

            /* ===== Create Purchase Request (merchant โ beneficiary) ===== */
            createPurchaseRequest: () => {
                const card = MerchantScanner.scannedCard;
                if (!card) return alert('ูุฑุฌู ูุณุญ ุจุทุงูุฉ ุงููุณุชููุฏ ุฃููุงู');

                const amount = parseFloat(document.getElementById('purchaseAmount')?.value);
                if (!amount || amount <= 0) return alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ');
                if (Number(card.balance) < amount) return alert('ุฑุตูุฏ ุงูุจุทุงูุฉ ุบูุฑ ูุงูู! ุงูุฑุตูุฏ: ' + Number(card.balance).toFixed(2) + ' ุฑูุงู');

                const code = String(Math.floor(100000 + Math.random() * 900000));
                const merchantUser = Auth.user;

                const pending = Storage.get('pendingPurchases') || [];
                const filtered = pending.filter(p => p.cardNumber !== card.number || p.status !== 'pending');
                filtered.push({
                    code: code,
                    cardNumber: card.number,
                    beneficiary: card.beneficiary,
                    wallet: card.wallet,
                    amount: amount,
                    merchant: merchantUser?.linkedEntity || merchantUser?.name || 'ุชุงุฌุฑ',
                    status: 'pending',
                    createdAt: Date.now(),
                    expiresAt: Date.now() + (5 * 60 * 1000)
                });
                Storage.set('pendingPurchases', filtered);

                document.getElementById('merchantCode').innerText = code;
                document.getElementById('merchantReqAmount').innerText = amount.toFixed(2);
                document.getElementById('purchaseRequestResult').style.display = 'block';
                document.getElementById('merchantReqStatus').innerText = 'โณ ุจุงูุชุธุงุฑ ุงูุชุฃููุฏ';
                document.getElementById('merchantReqStatus').style.background = '#f0ad4e';

                if (typeof showToast === 'function') showToast('ุชู ุฅุฑุณุงู ุทูุจ ุงูุดุฑุงุก ูููุณุชููุฏ', 'success');
                MerchantScanner.pollForConfirmation(code);
            },

            pollInterval: null,

            pollForConfirmation: (code) => {
                if (MerchantScanner.pollInterval) clearInterval(MerchantScanner.pollInterval);
                MerchantScanner.pollInterval = setInterval(() => {
                    const pending = Storage.get('pendingPurchases') || [];
                    const req = pending.find(p => p.code === code);
                    if (!req) { clearInterval(MerchantScanner.pollInterval); return; }

                    if (req.status === 'confirmed') {
                        clearInterval(MerchantScanner.pollInterval);
                        document.getElementById('merchantReqStatus').innerText = 'โ ุชู ุงูุชุฃููุฏ!';
                        document.getElementById('merchantReqStatus').style.background = '#28a745';
                        const cards = Storage.get('cards') || [];
                        const updatedCard = cards.find(c => c.number === req.cardNumber);
                        if (updatedCard) document.getElementById('resultBalance').innerText = Number(updatedCard.balance || 0).toFixed(2) + ' ุฑูุงู';
                        alert('โ ุชู ุชุฃููุฏ ุงูุดุฑุงุก!\nุงููุจูุบ: ' + req.amount.toFixed(2) + ' ุฑูุงู');
                    }
                    if (req.status === 'rejected') {
                        clearInterval(MerchantScanner.pollInterval);
                        document.getElementById('merchantReqStatus').innerText = 'โ ุชู ุงูุฑูุถ';
                        document.getElementById('merchantReqStatus').style.background = '#dc3545';
                        alert('โ ุงููุณุชููุฏ ุฑูุถ ุทูุจ ุงูุดุฑุงุก');
                    }
                    if (Date.now() > req.expiresAt && req.status === 'pending') {
                        clearInterval(MerchantScanner.pollInterval);
                        document.getElementById('merchantReqStatus').innerText = 'โฐ ุงูุชูุช ุงููููุฉ';
                        document.getElementById('merchantReqStatus').style.background = '#6c757d';
                    }
                }, 2000);
            },

            goToPOS: () => {
                if (!MerchantScanner.scannedCard) return alert('ูุฑุฌู ูุณุญ ุจุทุงูุฉ ุฃููุงู');

                // Check for confirmed purchase request
                const pending = Storage.get('pendingPurchases') || [];
                const confirmedReq = pending.find(p =>
                    p.cardNumber === MerchantScanner.scannedCard.number &&
                    p.status === 'confirmed'
                );

                if (!confirmedReq) {
                    return alert('โ๏ธ ูุง ูููู ุงูุงูุชูุงู ูููุทุฉ ุงูุจูุน!\n\nูุฌุจ ุฃููุงู:\n1. ุฅูุดุงุก ุทูุจ ุดุฑุงุก ูุฅุฏุฎุงู ุงููุจูุบ\n2. ุงูุชุธุงุฑ ุชุฃููุฏ ุงููุณุชููุฏ\n\nูู ูุชู ุงูุนุซูุฑ ุนูู ุทูุจ ุดุฑุงุก ูุคูุฏ.');
                }

                sessionStorage.setItem('posCardNumber', MerchantScanner.scannedCard.number);
                sessionStorage.setItem('posConfirmedCode', confirmedReq.code);
                sessionStorage.setItem('posConfirmedAmount', String(confirmedReq.amount));
                window.location.href = 'pos.html';
            },

            clearResult: () => {
                document.getElementById('scanCardNumber').value = '';
                document.getElementById('scanResult').style.display = 'none';
                const reqResult = document.getElementById('purchaseRequestResult');
                if (reqResult) reqResult.style.display = 'none';
                MerchantScanner.scannedCard = null;
                if (MerchantScanner.pollInterval) clearInterval(MerchantScanner.pollInterval);
            },

            showDebugInfo: () => {
                const pending = Storage.get('pendingPurchases') || [];
                const myName = Auth.user.linkedEntity || Auth.user.name;

                const msg = `
๐ ุชุดุฎูุต ุงูุชุงุฌุฑ:

๐ช ุงูุชุงุฌุฑ ุงูุญุงูู: ${myName}
๐จ ุนุฏุฏ ุงูุทูุจุงุช ุงููุนููุฉ (ุงููู): ${pending.length}
๐ ุชูุงุตูู ุงูุทูุจุงุช:
${pending.map(p => `- ููุฏ: ${p.code} | ูุจูุบ: ${p.amount} | ุญุงูุฉ: ${p.status} | ูุณุชููุฏ: ${p.beneficiary}`).join('\n')}

ุฅุฐุง ูุงู ุงูุทูุจ ูุธูุฑ ููุง ููุง ูุธูุฑ ุนูุฏ ุงููุณุชููุฏุ ููุฐุง ูุนูู ุฃู ุงููุณุชููุฏ ูุณุชุฎุฏู ูุชุตูุญุงู ุขุฎุฑ ุฃู ุฌูุงุฒุงู ุขุฎุฑ (ุบูุฑ ูุชุตู ุจููุณ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ).
`;
                alert(msg);
                console.log(msg);
            }
        };

        // ุชููุฆุฉ ุจุณูุทุฉ ููุชุงุฌุฑ (ุชุฌุฑูุจูุฉ)
        document.addEventListener('DOMContentLoaded', () => {
            const user = Auth.user;
            if (!user || user.role !== 'merchant') return;

            const tx = Storage.get('transactions') || [];
            const myTx = tx; // ูุจุฏุฆูุงู ูู ุงูุนูููุงุชุ ูุณุชูุจูุงู ูุฑุจุท ุงููุชุฌุฑ ุจุงูุญุณุงุจ
            document.getElementById('merchantTxCount').innerText = myTx.length;

            // ูุจูุนุงุช ุงูููู (ุจุฏูู ููุชุฑุฉ ุชุงุฑูุฎ ุฏูููุฉ ูู ูุฐุง ุงููููุฐุฌ)
            const total = myTx.reduce((s, t) => s + Number(t.amount || 0), 0);
            document.getElementById('merchantToday').innerText = total.toFixed(2);

            const tbody = document.getElementById('merchantTxTable');
            tbody.innerHTML = myTx.map(t => `
        <tr>
          <td>#${t.id}</td>
          <td>${t.card}</td>
          <td style="color:var(--brand-ink)"><strong>${Number(t.amount || 0).toFixed(2)} ุฑูุงู</strong></td>
          <td>${t.date}</td>
        </tr>
      `).join('');

            // Load Supply Orders for this merchant
            const merchantName = user.linkedEntity || user.name;

            // Restore any active pending purchase request
            const pending = Storage.get('pendingPurchases') || [];
            // Find request created by this merchant that is still pending/confirmed and not expired
            const activeReq = pending.find(p =>
                (p.merchant === merchantName) &&
                (p.status === 'pending' || p.status === 'confirmed') &&
                Date.now() < p.expiresAt
            );

            if (activeReq) {
                // Restore UI state
                document.getElementById('merchantCode').innerText = activeReq.code;
                document.getElementById('merchantReqAmount').innerText = Number(activeReq.amount).toFixed(2);
                document.getElementById('purchaseRequestResult').style.display = 'block';

                if (activeReq.status === 'confirmed') {
                    document.getElementById('merchantReqStatus').innerText = 'โ ุชู ุงูุชุฃููุฏ!';
                    document.getElementById('merchantReqStatus').style.background = '#28a745';
                } else {
                    document.getElementById('merchantReqStatus').innerText = 'โณ ุจุงูุชุธุงุฑ ุงูุชุฃููุฏ';
                    document.getElementById('merchantReqStatus').style.background = '#f0ad4e';
                    // Restart polling
                    MerchantScanner.pollForConfirmation(activeReq.code);
                }

                // Also restore scanned card details if possible
                const cards = Storage.get('cards') || [];
                const card = cards.find(c => c.number === activeReq.cardNumber);
                if (card) {
                    MerchantScanner.scannedCard = card;
                    document.getElementById('resultCardNum').innerText = card.number;
                    document.getElementById('resultBeneficiary').innerText = card.beneficiary || 'ุบูุฑ ูุญุฏุฏ';
                    document.getElementById('resultWallet').innerText = card.wallet || '-';
                    document.getElementById('resultBalance').innerText = Number(card.balance || 0).toFixed(2) + ' ุฑูุงู';
                    document.getElementById('resultIdentity').innerText = card.identity || '-';
                    const statusText = (card.status === 'ูุดุท' || card.status === 'Active') ? 'ูุดุท โ' : 'ููููู โ';
                    document.getElementById('resultStatus').innerText = statusText;
                    document.getElementById('scanResult').style.display = 'block';
                }
            }

            // Display the target name for confirmation (optional, helps debugging)
            const header = document.querySelector('h3[style*="margin-top:24px"]');
            if (header) header.innerHTML = `ุฃูุงูุฑ ุงูุชูุฑูุฏ ุงููุงุฑุฏุฉ <small style="font-size:0.8em; color:var(--text-secondary)">(${merchantName})</small>`;

            if (typeof Orders !== 'undefined' && Orders.loadForMerchant) {
                Orders.loadForMerchant(merchantName);
            }
        });
    </script>

    <script>
        // PWA Service Worker Register
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed!', err));
            });
        }
    </script>

</body>

</html>