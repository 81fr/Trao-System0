<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>لوحة التاجر - تراوف</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all-svg.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="assets/logo.png" alt=""></div>
        <ul class="nav-links">
            <li><a href="merchant_home.html" class="active"><i class="fas fa-store"></i> لوحة التاجر</a></li>
            <li><a href="pos.html"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
            <li><a href="support.html"><i class="fas fa-headset"></i> الدعم الفني</a></li>
            <li><a href="#" onclick="Auth.logout()"><i class="fas fa-sign-out-alt"></i> تسجيل خروج</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header>
            <h1><i class="fas fa-store"></i> مرحباً بالتاجر</h1>
            <div class="user-profile"><span>مرحباً</span>
                <div class="avatar">ت</div>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="icon"><i class="fas fa-exchange-alt"></i></div>
                <h3>عدد العمليات</h3>
                <div class="value" id="merchantTxCount">0</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-wallet"></i></div>
                <h3>مبيعات اليوم</h3>
                <div class="value" id="merchantToday">0</div>
            </div>
        </div>

        <!-- ===== QR Scanner Section ===== -->
        <div class="form-container" style="border-top: 4px solid var(--brand-teal);">
            <h3><i class="fas fa-qrcode"></i> مسح بطاقة المستفيد</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">افتح الكاميرا لمسح رمز QR الخاص ببطاقة
                المستفيد، أو أدخل الرقم يدوياً.</p>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-bottom:15px;">
                <div class="form-group" style="flex:1; min-width:200px; margin-bottom:0;">
                    <label>رقم البطاقة</label>
                    <input id="scanCardNumber" type="text" placeholder="أدخل رقم البطاقة أو رقم الهوية">
                </div>
                <button onclick="MerchantScanner.lookupCard()" style="white-space:nowrap;">
                    <i class="fas fa-search"></i> بحث
                </button>
                <button id="btnStartScan" onclick="MerchantScanner.startScan()"
                    style="background:var(--brand-teal); white-space:nowrap;">
                    <i class="fas fa-camera"></i> فتح الكاميرا
                </button>
                <button id="btnStopScan" onclick="MerchantScanner.stopScan()"
                    style="background:#dc3545; display:none; white-space:nowrap;">
                    <i class="fas fa-times"></i> إغلاق الكاميرا
                </button>
            </div>

            <!-- Camera Preview -->
            <div id="qr-reader"
                style="display:none; max-width:400px; margin:0 auto 15px; border-radius:12px; overflow:hidden; border:2px solid var(--brand-teal);">
            </div>

            <!-- Scan Result Card -->
            <div id="scanResult"
                style="display:none; background:#f0faf9; border:1px solid #c9e8e5; border-radius:12px; padding:16px;">
                <h4 style="margin:0 0 10px; color:var(--brand-teal);"><i class="fas fa-id-card"></i> بيانات البطاقة</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><strong>رقم البطاقة:</strong> <span id="resultCardNum">-</span></div>
                    <div><strong>المستفيد:</strong> <span id="resultBeneficiary">-</span></div>
                    <div><strong>رقم الهوية:</strong> <span id="resultIdentity">-</span></div>
                    <div><strong>المحفظة:</strong> <span id="resultWallet">-</span></div>
                    <div><strong>الرصيد:</strong> <span id="resultBalance"
                            style="color:var(--brand-teal); font-weight:bold;">-</span></div>
                    <div><strong>الحالة:</strong> <span id="resultStatus">-</span></div>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button onclick="MerchantScanner.goToPOS()" style="flex:1;">
                        <i class="fas fa-cash-register"></i> الانتقال لنقطة البيع
                    </button>
                    <button class="secondary" onclick="MerchantScanner.clearResult()">
                        <i class="fas fa-redo"></i> مسح جديد
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== Purchase Code Verification ===== -->
        <div class="form-container" style="border-top: 4px solid #8CC240; margin-top:20px;">
            <h3><i class="fas fa-ticket-alt"></i> تحقق من كود الشراء</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">أدخل كود الشراء المكوّن من 6 أرقام الذي حصلت
                عليه من المستفيد، أو امسح رمز QR الخاص بالكود.</p>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div class="form-group" style="flex:1; min-width:180px; margin-bottom:0;">
                    <label>كود الشراء</label>
                    <input id="purchaseCodeInput" type="text" maxlength="6" placeholder="أدخل الكود المكوّن من 6 أرقام"
                        style="font-size:1.2rem; letter-spacing:5px; text-align:center; font-family:monospace;">
                </div>
                <button onclick="MerchantScanner.verifyPurchaseCode()" style="background:#8CC240; white-space:nowrap;">
                    <i class="fas fa-check-circle"></i> تحقق
                </button>
            </div>

            <!-- Purchase Code Result -->
            <div id="payCodeResult"
                style="display:none; margin-top:15px; background:linear-gradient(135deg, #f0faf9, #e8f5e9); border:2px solid #8CC240; border-radius:12px; padding:20px;">
                <h4 style="margin:0 0 12px; color:#8CC240;"><i class="fas fa-receipt"></i> تفاصيل كود الشراء</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><strong>المستفيد:</strong> <span id="payBeneficiary">-</span></div>
                    <div><strong>رقم البطاقة:</strong> <span id="payCardNum">-</span></div>
                    <div><strong>المحفظة:</strong> <span id="payWallet">-</span></div>
                    <div style="font-size:1.2rem;"><strong>المبلغ:</strong> <span id="payAmount"
                            style="color:#8CC240; font-weight:bold;">-</span></div>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button onclick="MerchantScanner.confirmPurchase()"
                        style="background:#8CC240; flex:1; font-size:1.1rem;">
                        <i class="fas fa-check-double"></i> تأكيد الشراء وخصم المبلغ
                    </button>
                    <button class="secondary" onclick="document.getElementById('payCodeResult').style.display='none'">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>

        <h3 style="margin-top:24px;">أوامر التوريد الواردة</h3>
        <div class="table-container" style="margin-bottom:24px;">
            <table>
                <thead>
                    <tr>
                        <th>رقم الأمر</th>
                        <th>الصنف / الخدمة</th>
                        <th>القيمة</th>
                        <th>التاريخ</th>
                        <th>الحالة</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody id="merchantOrdersTable"></tbody>
            </table>
        </div>

        <h3>آخر العمليات</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>البطاقة</th>
                        <th>المبلغ</th>
                        <th>التاريخ</th>
                    </tr>
                </thead>
                <tbody id="merchantTxTable"></tbody>
            </table>
        </div>
        <footer class="main-footer">
            <p>صنع في تراؤف</p>
            <img src="assets/logo.png" alt="TRAOF Logo">
        </footer>
    </main>

    <script src="script.js"></script>
    <script>
        /* ===== QR Scanner Logic ===== */
        const MerchantScanner = {
            scanner: null,
            scannedCard: null,

            startScan: () => {
                const readerDiv = document.getElementById('qr-reader');
                readerDiv.style.display = 'block';
                document.getElementById('btnStartScan').style.display = 'none';
                document.getElementById('btnStopScan').style.display = '';

                MerchantScanner.scanner = new Html5Qrcode('qr-reader');
                MerchantScanner.scanner.start(
                    { facingMode: 'environment' },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        // Success — check if it's a purchase code QR
                        if (decodedText.startsWith('PAY:')) {
                            const code = decodedText.replace('PAY:', '');
                            document.getElementById('purchaseCodeInput').value = code;
                            MerchantScanner.stopScan();
                            MerchantScanner.verifyPurchaseCode();
                            if (typeof showToast === 'function') showToast('تم مسح كود الشراء!', 'success');
                        } else {
                            document.getElementById('scanCardNumber').value = decodedText;
                            MerchantScanner.stopScan();
                            MerchantScanner.lookupCard();
                            if (typeof showToast === 'function') showToast('تم مسح الكود بنجاح!', 'success');
                        }
                    },
                    (errorMessage) => {
                        // Ignore scan errors (normal during scanning)
                    }
                ).catch(err => {
                    alert('تعذر فتح الكاميرا. تأكد من منح صلاحية الكاميرا.');
                    MerchantScanner.stopScan();
                });
            },

            stopScan: () => {
                if (MerchantScanner.scanner) {
                    MerchantScanner.scanner.stop().then(() => {
                        MerchantScanner.scanner.clear();
                    }).catch(() => { });
                }
                document.getElementById('qr-reader').style.display = 'none';
                document.getElementById('btnStartScan').style.display = '';
                document.getElementById('btnStopScan').style.display = 'none';
            },

            lookupCard: () => {
                const input = document.getElementById('scanCardNumber').value.trim();
                if (!input) return alert('يرجى إدخال رقم البطاقة أو رقم الهوية أو مسح QR أولاً');

                const cards = Storage.get('cards') || [];
                const beneficiaries = Storage.get('beneficiaries') || [];

                console.log('Scanner input:', input);
                console.log('Available cards:', cards.map(c => c.number));

                // Search by exact card number
                let card = cards.find(c => c.number === input);

                // Search by identity number
                if (!card) card = cards.find(c => c.identity === input);

                // Search by beneficiary name
                if (!card) card = cards.find(c => c.beneficiary === input);

                // Try partial match (contains)
                if (!card) card = cards.find(c => c.number && c.number.includes(input));
                if (!card) card = cards.find(c => c.identity && c.identity.includes(input));

                // Try matching via beneficiaries table (identity -> name -> card)
                if (!card) {
                    const ben = beneficiaries.find(b => b.identity === input || b.name === input);
                    if (ben) {
                        card = cards.find(c => c.beneficiary === ben.name);
                    }
                }

                if (!card) {
                    document.getElementById('scanResult').style.display = 'none';
                    const available = cards.map(c => c.number).join(', ');
                    return alert('لم يتم العثور على بطاقة.\nالقيمة الممسوحة: ' + input + '\nالبطاقات المتوفرة: ' + (available || 'لا توجد بطاقات'));
                }

                MerchantScanner.scannedCard = card;

                document.getElementById('resultCardNum').innerText = card.number;
                document.getElementById('resultBeneficiary').innerText = card.beneficiary || 'غير محدد';
                document.getElementById('resultWallet').innerText = card.wallet || '-';
                document.getElementById('resultBalance').innerText = Number(card.balance || 0).toFixed(2) + ' ريال';
                document.getElementById('resultIdentity').innerText = card.identity || '-';

                const statusText = (card.status === 'نشط' || card.status === 'Active') ? 'نشط ✅' : 'موقوف ❌';
                document.getElementById('resultStatus').innerText = statusText;

                document.getElementById('scanResult').style.display = 'block';
            },

            verifyPurchaseCode: () => {
                const codeInput = document.getElementById('purchaseCodeInput').value.trim();
                if (!codeInput || codeInput.length !== 6) return alert('يرجى إدخال كود شراء صحيح مكوّن من 6 أرقام');

                const purchaseCodes = Storage.get('purchaseCodes') || [];
                const pc = purchaseCodes.find(p => p.code === codeInput && !p.used);

                if (!pc) return alert('كود الشراء غير صالح أو مستخدم مسبقاً');

                if (Date.now() > pc.expiresAt) return alert('كود الشراء منتهي الصلاحية. اطلب من المستفيد إنشاء كود جديد.');

                // Store for confirmation
                MerchantScanner.pendingPurchase = pc;

                // Display
                document.getElementById('payBeneficiary').innerText = pc.beneficiary || '-';
                document.getElementById('payCardNum').innerText = pc.cardNumber || '-';
                document.getElementById('payWallet').innerText = pc.wallet || '-';
                document.getElementById('payAmount').innerText = Number(pc.amount).toFixed(2) + ' ريال';
                document.getElementById('payCodeResult').style.display = 'block';

                if (typeof showToast === 'function') showToast('كود الشراء صالح ✅', 'success');
            },

            confirmPurchase: () => {
                const pc = MerchantScanner.pendingPurchase;
                if (!pc) return alert('لا يوجد كود شراء للتأكيد');

                // Deduct from card balance
                const cards = Storage.get('cards') || [];
                const card = cards.find(c => c.number === pc.cardNumber);
                if (!card) return alert('لم يتم العثور على البطاقة');
                if (Number(card.balance) < pc.amount) return alert('رصيد البطاقة غير كافي');

                card.balance = Number(card.balance) - pc.amount;
                Storage.set('cards', cards);

                // Record transaction
                const transactions = Storage.get('transactions') || [];
                const merchantUser = Auth.user;
                transactions.push({
                    id: transactions.length + 1000,
                    card: pc.cardNumber,
                    amount: pc.amount,
                    date: new Date().toISOString().split('T')[0],
                    merchant: merchantUser?.linkedEntity || merchantUser?.name || 'تاجر',
                    type: 'شراء بكود'
                });
                Storage.set('transactions', transactions);

                // Mark code as used
                const purchaseCodes = Storage.get('purchaseCodes') || [];
                const codeObj = purchaseCodes.find(p => p.code === pc.code);
                if (codeObj) codeObj.used = true;
                Storage.set('purchaseCodes', purchaseCodes);

                // Cleanup
                MerchantScanner.pendingPurchase = null;
                document.getElementById('payCodeResult').style.display = 'none';
                document.getElementById('purchaseCodeInput').value = '';

                alert('✅ تمت عملية الشراء بنجاح!\nالمبلغ: ' + pc.amount.toFixed(2) + ' ريال\nالرصيد المتبقي: ' + card.balance.toFixed(2) + ' ريال');

                if (typeof showToast === 'function') showToast('تم خصم المبلغ بنجاح!', 'success');
            },

            pendingPurchase: null,

            goToPOS: () => {
                if (MerchantScanner.scannedCard) {
                    // Store card number for POS to pick up
                    sessionStorage.setItem('posCardNumber', MerchantScanner.scannedCard.number);
                    window.location.href = 'pos.html';
                }
            },

            clearResult: () => {
                document.getElementById('scanCardNumber').value = '';
                document.getElementById('scanResult').style.display = 'none';
                MerchantScanner.scannedCard = null;
            }
        };

        // تهيئة بسيطة للتاجر (تجريبية)
        document.addEventListener('DOMContentLoaded', () => {
            const user = Auth.user;
            if (!user || user.role !== 'merchant') return;

            const tx = Storage.get('transactions') || [];
            const myTx = tx; // مبدئياً كل العمليات؛ مستقبلاً نربط المتجر بالحساب
            document.getElementById('merchantTxCount').innerText = myTx.length;

            // مبيعات اليوم (بدون فلترة تاريخ دقيقة في هذا النموذج)
            const total = myTx.reduce((s, t) => s + Number(t.amount || 0), 0);
            document.getElementById('merchantToday').innerText = total.toFixed(2);

            const tbody = document.getElementById('merchantTxTable');
            tbody.innerHTML = myTx.map(t => `
        <tr>
          <td>#${t.id}</td>
          <td>${t.card}</td>
          <td style="color:var(--brand-ink)"><strong>${Number(t.amount || 0).toFixed(2)} ريال</strong></td>
          <td>${t.date}</td>
        </tr>
      `).join('');

            // Load Supply Orders for this merchant
            const merchantName = user.linkedEntity || user.name;

            // Display the target name for confirmation (optional, helps debugging)
            const header = document.querySelector('h3[style*="margin-top:24px"]');
            if (header) header.innerHTML = `أوامر التوريد الواردة <small style="font-size:0.8em; color:var(--text-secondary)">(${merchantName})</small>`;

            if (typeof Orders !== 'undefined' && Orders.loadForMerchant) {
                Orders.loadForMerchant(merchantName);
            }
        });
    </script>
</body>

</html>