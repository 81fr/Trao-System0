<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø© - ØªØ±Ø§Ø¤Ù</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background: #f4f6f9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .merchant-box {
            border-top: 5px solid #8CC240;
        }

        .beneficiary-box {
            border-top: 5px solid #00a59b;
        }

        .data-box {
            border-top: 5px solid #3e4559;
        }

        h2 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            color: #3e4559;
        }

        .log-box {
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            direction: ltr;
            margin-top: 20px;
            border: 1px solid #444;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        th {
            background: #f8f9fa;
            color: #666;
        }

        .btn-action {
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    </style>
</head>

<body>

    <h1 style="text-align:center; color:#3e4559; margin-bottom:10px;">
        <i class="fas fa-stethoscope"></i> Ù„ÙˆØ­Ø© ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    </h1>
    <p style="text-align:center; color:#666; margin-bottom: 30px;">
        ØªØ³Ù…Ø­ Ù„Ùƒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¨Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù… (Data Inspector) ÙˆØ¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ§Øª Ø´Ø±Ø§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
    </p>

    <div class="dashboard-grid">

        <!-- DATA INSPECTOR -->
        <div class="card-box data-box" style="grid-column: 1 / -1;">
            <h2><i class="fas fa-database"></i> Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Live Data)</h2>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="flex:1;">
                    <h3>ğŸ’³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø±Ù‚Ù…</th>
                                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="tblCards"></tbody>
                    </table>
                </div>
                <div style="flex:1;">
                    <h3>ğŸ“¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ (PendingRequests)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                <th>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="tblPandings"></tbody>
                    </table>
                </div>
            </div>
            <div style="text-align:left; margin-top:10px;">
                <button onclick="localStorage.clear(); location.reload();"
                    style="background:#dc3545; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âš ï¸
                    Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Reset Log)</button>
                <button onclick="location.reload()"
                    style="background:#6c757d; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ”„
                    ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>

        <!-- MERCHANT SIMULATION -->
        <div class="card-box merchant-box">
            <h2><i class="fas fa-cash-register"></i> Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ§Ø¬Ø±</h2>
            <div class="form-group" style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <select id="simCardSelect" style="width:100%; padding: 10px; border:1px solid #ddd; border-radius:8px;">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div class="form-group" style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„):</label>
                <input type="number" id="simAmount" value="50"
                    style="width:100%; padding: 10px; border:1px solid #ddd; border-radius:8px;">
            </div>
            <button onclick="TestFlow.createRequest()" class="btn-action" style="background:#8CC240;">
                <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡
            </button> <!-- MERCHANT RESULT -->
            <div id="merchantResult"
                style="margin-top:20px; display:none; text-align:center; background:#f9f9f9; padding:15px; border-radius:8px;">
                <p style="color:#666; margin:0;">ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</p>
                <h1 id="simGeneratedCode" style="letter-spacing: 5px; color: #8CC240; margin:10px 0;">------</h1>
                <span id="simMerchantStatus" class="status-badge status-pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯...</span>
            </div>
        </div>

        <!-- BENEFICIARY SIMULATION -->
        <div class="card-box beneficiary-box">
            <h2><i class="fas fa-user-check"></i> Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</h2>

            <div id="beneficiaryView"
                style="text-align:center; padding: 20px; min-height:120px; display:flex; flex-direction:column; align-items:center; justify-content:center; border: 2px dashed #eee; border-radius:10px; margin-bottom:20px;">
                <p style="color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            </div>

            <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
                <label style="display:block; margin-bottom:8px; font-size:0.9rem; color:#666;">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹
                    (Fallback):</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="simManualCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"
                        style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; text-align:center; letter-spacing:2px;">
                    <button onclick="TestFlow.manualCheck()" class="btn-action"
                        style="background:#00a59b; width:auto; flex:1;">
                        <i class="fas fa-search"></i> ØªØ­Ù‚Ù‚
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="log-box" id="debugLog">
        <div>> System Monitor Initialized... Waiting for actions.</div>
    </div>

    <script src="script.js"></script>
    <script>
        const TestFlow = {
            init: () => {
                TestFlow.refreshDataTables();

                // Load select options
                const cards = Storage.get('cards') || [];
                const select = document.getElementById('simCardSelect');
                if (cards.length > 0) {
                    select.innerHTML = cards.map(c =>
                        `<option value="${c.number}">${c.beneficiary} (${c.number}) - ${c.balance} Ø±ÙŠØ§Ù„</option>`
                    ).join('');
                } else {
                    select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø³Ø¬Ù„Ø©</option>';
                }

                // Polling
                setInterval(() => {
                    TestFlow.pollBeneficiary();
                    TestFlow.pollMerchant();
                    // Auto-refresh data monitor occasionally
                    if (document.visibilityState === 'visible') TestFlow.refreshDataTables();
                }, 2000);
            },

            log: (msg) => {
                const box = document.getElementById('debugLog');
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                const div = document.createElement('div');
                div.innerText = `[${time}] ${msg}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            },

            refreshDataTables: () => {
                const cards = Storage.get('cards') || [];
                const pending = Storage.get('pendingPurchases') || [];

                document.getElementById('tblCards').innerHTML = cards.map(c => `
                    <tr>
                        <td>${c.beneficiary}</td>
                        <td style="font-family:monospace">${c.number}</td>
                        <td>${c.balance}</td>
                        <td>${c.status}</td>
                    </tr>
                `).join('');

                document.getElementById('tblPandings').innerHTML = pending.length ? pending.map(p => `
                    <tr>
                        <td style="font-family:monospace; font-weight:bold">${p.code}</td>
                        <td>${p.cardNumber}</td>
                        <td>${p.amount}</td>
                        <td><span class="status-badge ${p.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">${p.status}</span></td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center; color:#999">Ù„Ø§ ÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
            },

            createRequest: () => {
                const cardNum = document.getElementById('simCardSelect').value;
                if (!cardNum) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø·Ø§Ù‚Ø©');

                const amount = parseFloat(document.getElementById('simAmount').value);
                const code = String(Math.floor(100000 + Math.random() * 900000));

                const cards = Storage.get('cards') || [];
                const card = cards.find(c => c.number === cardNum);

                const merchantName = 'Test Merchant'; // Mock

                // --- CORE LOGIC: Save to Real Storage ---
                const pending = Storage.get('pendingPurchases') || [];
                // Remove old pending for this card to keep clean
                const filtered = pending.filter(p => p.cardNumber !== cardNum || p.status !== 'pending');

                const newReq = {
                    code: code,
                    cardNumber: cardNum,
                    beneficiary: card.beneficiary,
                    amount: amount,
                    merchant: merchantName,
                    wallet: card.wallet,
                    status: 'pending',
                    createdAt: Date.now(),
                    expiresAt: Date.now() + 300000
                };

                filtered.push(newReq);
                Storage.set('pendingPurchases', filtered);
                // ----------------------------------------

                // Update UI
                const resDiv = document.getElementById('merchantResult');
                resDiv.style.display = 'block';
                document.getElementById('simGeneratedCode').innerText = code;
                const statusEl = document.getElementById('simMerchantStatus');
                statusEl.innerText = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯...';
                statusEl.className = 'status-badge status-pending';
                statusEl.style.background = '#fff3cd';

                TestFlow.log(`ğŸŸ¢ [MERCHANT] Created Request: Code ${code} | Amount: ${amount}`);
                TestFlow.refreshDataTables();
            },

            pollBeneficiary: () => {
                const pending = Storage.get('pendingPurchases') || [];
                const active = pending.find(p => p.status === 'pending');
                const container = document.getElementById('beneficiaryView');

                if (active) {
                    if (!container.innerHTML.includes(active.code)) { // Update only if new
                        container.innerHTML = `
                            <div style="width:100%;">
                                <div style="color:#00a59b; font-size:3rem; margin-bottom:10px;">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <h3 style="margin:0;">Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ ÙˆØ§Ø±Ø¯</h3>
                                <div style="background:#e3fefa; border:1px solid #00a59b; border-radius:8px; padding:15px; margin:15px 0;">
                                    <h1 style="color:#00a59b; margin:0; letter-spacing:5px;">${active.code}</h1>
                                    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.9rem;">
                                        <span>Ø§Ù„Ù…Ø¨Ù„Øº: <strong>${active.amount}</strong></span>
                                        <span>Ø§Ù„ØªØ§Ø¬Ø±: ${active.merchant}</span>
                                    </div>
                                </div>
                                <button onclick="TestFlow.confirm('${active.code}')" class="btn-action" style="background:#28a745;">
                                    <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                                </button>
                            </div>
                        `;
                        TestFlow.log(`ğŸ”” [BENEFICIARY] Received Request: ${active.code}`);
                    }
                } else {
                    if (!container.innerHTML.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª')) {
                        container.innerHTML = '<p style="color:#999"><i class="fas fa-spinner fa-spin"></i> Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨Ø§Øª...</p>';
                    }
                }
            },

            pollMerchant: () => {
                const code = document.getElementById('simGeneratedCode').innerText;
                if (code === '------') return;

                const pending = Storage.get('pendingPurchases') || [];
                const req = pending.find(p => p.code === code);

                if (req && req.status === 'confirmed') {
                    const statusEl = document.getElementById('simMerchantStatus');
                    if (statusEl.innerText !== 'âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯!') {
                        statusEl.innerText = 'âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯!';
                        statusEl.className = 'status-badge status-confirmed';
                        statusEl.style.background = '#d4edda';

                        TestFlow.log(`âœ… [MERCHANT] Confirmation Received for Code ${code}`);
                        alert('âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø±ØµÙŠØ¯ ØªÙ… Ø­Ø¬Ø²Ù‡.');
                        TestFlow.refreshDataTables();
                    }
                }
            },

            confirm: (code) => {
                const pending = Storage.get('pendingPurchases') || [];
                const reqIndex = pending.findIndex(p => p.code === code);

                if (reqIndex !== -1) {
                    pending[reqIndex].status = 'confirmed';
                    Storage.set('pendingPurchases', pending);
                    TestFlow.log(`ğŸ‘ [BENEFICIARY] Confirmed (${code})`);

                    // Clear Simulation UI
                    document.getElementById('beneficiaryView').innerHTML = '<div style="color:#28a745; font-size:1.2rem; font-weight:bold;"><i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­</div>';
                    setTimeout(() => TestFlow.refreshDataTables(), 500);
                } else {
                    alert('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
                }
            },

            manualCheck: () => {
                const code = document.getElementById('simManualCode').value;
                if (code) {
                    TestFlow.log(`ğŸ” [BENEFICIARY] Manual check for: ${code}`);
                    TestFlow.confirm(code);
                }
            }
        };

        window.onload = TestFlow.init;
    </script>
</body>

</html>