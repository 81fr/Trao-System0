<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    
    <title>ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„ - ØªØ±Ø§ÙˆÙ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: #f0f2f5;
            padding: 24px;
            color: #3E4559
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: #00A59B;
            font-size: 1.5rem
        }

        .actions {
            text-align: center;
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap
        }

        .btn {
            padding: 10px 22px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Tajawal';
            font-size: .9rem;
            font-weight: 600;
            transition: all .2s
        }

        .btn-teal {
            background: linear-gradient(135deg, #00A59B, #8CC240);
            color: white
        }

        .btn-red {
            background: #ef4444;
            color: white
        }

        .btn-blue {
            background: #3b82f6;
            color: white
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15)
        }

        .card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, .05)
        }

        .card h3 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: .95rem
        }

        .test-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: .85rem
        }

        .test-row:last-child {
            border: none
        }

        .test-name {
            flex: 1
        }

        .test-status {
            min-width: 90px;
            text-align: center;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: .75rem;
            font-weight: 600
        }

        .pass {
            background: #ecfdf5;
            color: #059669
        }

        .fail {
            background: #fef2f2;
            color: #dc2626
        }

        .warn {
            background: #fffbeb;
            color: #d97706
        }

        .info {
            background: #eff6ff;
            color: #2563eb
        }

        .details {
            font-size: .78rem;
            color: #8c97a8;
            margin-top: 2px
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 20px
        }

        .sbox {
            background: white;
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .04)
        }

        .sbox .sv {
            font-size: 1.6rem;
            font-weight: 800
        }

        .sbox .sl {
            font-size: .72rem;
            color: #8c97a8
        }

        .s-green .sv {
            color: #059669
        }

        .s-red .sv {
            color: #dc2626
        }

        .s-blue .sv {
            color: #3b82f6
        }

        .s-orange .sv {
            color: #d97706
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px
        }

        th {
            text-align: right;
            padding: 8px;
            font-size: .72rem;
            color: #8c97a8;
            background: #fafbfc;
            border-bottom: 2px solid #eee
        }

        td {
            padding: 8px;
            font-size: .82rem;
            border-bottom: 1px solid #f5f5f5
        }

        .log {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 14px;
            font-family: monospace;
            font-size: .78rem;
            max-height: 200px;
            overflow-y: auto;
            direction: ltr;
            text-align: left
        }

        .log .ok {
            color: #4ade80
        }

        .log .err {
            color: #f87171
        }

        .log .wrn {
            color: #fbbf24
        }
    </style>

    <!-- PWA / Mobile App Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00A59B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

</head>

<body>
    <h1>ğŸ” ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„ â€” TRAOF System Check</h1>

    <div class="actions">
        <button class="btn btn-blue" onclick="window.location.href='index.html'">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn btn-red" onclick="clearAndReload()">ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
        <button class="btn btn-teal" onclick="runAllTests()">â–¶ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª</button>
        <button class="btn btn-blue" onclick="createTestOrders()">ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆØ§Ù…Ø± ØªÙˆØ±ÙŠØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
    </div>

    <div class="summary" id="summaryBox"></div>

    <div class="card">
        <h3>ğŸ“¦ ÙØ­Øµ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</h3>
        <div id="ordersTests"></div>
    </div>

    <div class="card">
        <h3>ğŸ’¾ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©</h3>
        <div id="dataTests"></div>
    </div>

    <div class="card">
        <h3>ğŸ“„ ÙØ­Øµ Ø§Ù„ØµÙØ­Ø§Øª</h3>
        <div id="pageTests"></div>
    </div>

    <div class="card">
        <h3>ğŸ“¦ Ø¬Ø¯ÙˆÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ù…Ù†ÙØ°</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody id="ordersTable"></tbody>
        </table>
    </div>

    <div class="card">
        <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ÙØ­Øµ</h3>
        <div class="log" id="logBox"></div>
    </div>

    <script>
        // ====== Storage Helper ======
        const Storage = {
            get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch (e) { return null; } },
            set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
            add: (k, item) => { const arr = Storage.get(k) || []; arr.push(item); Storage.set(k, arr); }
        };

        let log = [];
        function addLog(msg, type = 'ok') {
            log.push({ msg, type });
            const box = document.getElementById('logBox');
            box.innerHTML = log.map(l => `<div class="${l.type}">${l.type === 'ok' ? 'âœ…' : l.type === 'err' ? 'âŒ' : 'âš ï¸'} ${l.msg}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }

        function addTest(containerId, name, passed, detail = '') {
            const div = document.getElementById(containerId);
            div.innerHTML += `<div class="test-row">
            <div class="test-name">${name}${detail ? '<div class="details">' + detail + '</div>' : ''}</div>
            <div class="test-status ${passed === true ? 'pass' : passed === false ? 'fail' : 'warn'}">${passed === true ? 'âœ… Ù†Ø§Ø¬Ø­' : passed === false ? 'âŒ ÙØ§Ø´Ù„' : 'âš ï¸ ØªØ­Ø°ÙŠØ±'}</div>
        </div>`;
        }

        function clearAndReload() {
            localStorage.clear();
            addLog('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage', 'ok');
            alert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');
            location.reload();
        }

        function createTestOrders() {
            addLog('Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆØ§Ù…Ø± ØªÙˆØ±ÙŠØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠØ©...', 'ok');

            // Ensure merchants exist
            let merchants = Storage.get('merchants');
            if (!merchants || merchants.length === 0) {
                merchants = [
                    { id: 101, name: 'Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø«ÙŠÙ…', category: 'Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', transactions: 245, status: 'Ù†Ø´Ø·' },
                    { id: 102, name: 'Ø¨Ù†Ø¯Ø©', category: 'Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', transactions: 198, status: 'Ù†Ø´Ø·' },
                    { id: 103, name: 'Ø§Ù„Ø¯Ø§Ù†ÙˆØ¨', category: 'Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', transactions: 145, status: 'Ù†Ø´Ø·' },
                    { id: 104, name: 'Ø§Ù„ØªÙ…ÙŠÙ…ÙŠ', category: 'Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', transactions: 88, status: 'Ù†Ø´Ø·' },
                    { id: 201, name: 'Ø³Ù†ØªØ±Ø¨ÙˆÙŠÙ†Øª', category: 'Ù…Ù„Ø§Ø¨Ø³', transactions: 176, status: 'Ù†Ø´Ø·' },
                    { id: 202, name: 'Ø¥ÙƒØ³ØªØ±Ø§', category: 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', transactions: 82, status: 'Ù†Ø´Ø·' },
                    { id: 301, name: 'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù†Ù‡Ø¯ÙŠ', category: 'Ø£Ø¯ÙˆÙŠØ©', transactions: 310, status: 'Ù†Ø´Ø·' },
                    { id: 302, name: 'Ù…ÙƒØªØ¨Ø© Ø¬Ø±ÙŠØ±', category: 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ù…Ø¯Ø±Ø³ÙŠØ©', transactions: 67, status: 'Ù†Ø´Ø·' },
                    { id: 303, name: 'Ø§Ù„Ù…Ù†ÙŠØ¹', category: 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', transactions: 43, status: 'Ù†Ø´Ø·' },
                    { id: 304, name: 'Ù…Ø§ÙƒØ³', category: 'Ù…Ù„Ø§Ø¨Ø³', transactions: 95, status: 'Ù†Ø´Ø·' },
                    { id: 305, name: 'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ø¡', category: 'Ø£Ø¯ÙˆÙŠØ©', transactions: 120, status: 'Ù†Ø´Ø·' },
                    { id: 306, name: 'Ø§ÙŠÙƒÙŠØ§', category: 'Ø£Ø«Ø§Ø«', transactions: 35, status: 'Ù†Ø´Ø·' },
                    { id: 307, name: 'Ø³Ø§ÙƒÙˆ', category: 'Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©', transactions: 52, status: 'Ù†Ø´Ø·' },
                    { id: 308, name: 'Ù‡ÙˆÙ… Ø³Ù†ØªØ±', category: 'Ø£Ø«Ø§Ø«', transactions: 28, status: 'Ù†Ø´Ø·' }
                ];
                Storage.set('merchants', merchants);
                addLog('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ 14 Ù…ØªØ¬Ø±', 'ok');
            }

            const testOrders = [
                { id: '100201', item: 'ØªÙˆØ±ÙŠØ¯ Ø³Ù„Ø§Ù„ ØºØ°Ø§Ø¦ÙŠØ© (Ø£Ø±Ø²ØŒ Ø³ÙƒØ±ØŒ Ø²ÙŠØª) - 500 Ø³Ù„Ø©', partner: 'Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø«ÙŠÙ…', cost: 15000, date: '2024-01-05', status: 'Completed' },
                { id: '100202', item: 'ØªÙˆØ±ÙŠØ¯ Ø¨Ø·Ø§Ù†ÙŠØ§Øª Ø´ØªÙˆÙŠØ© (200 Ø¨Ø·Ø§Ù†ÙŠØ©)', partner: 'Ø³Ù†ØªØ±Ø¨ÙˆÙŠÙ†Øª', cost: 8000, date: '2024-01-10', status: 'Completed' },
                { id: '100203', item: 'ØªÙˆØ±ÙŠØ¯ Ø£Ø¬Ù‡Ø²Ø© ØªÙƒÙŠÙŠÙ Ø³Ø¨Ù„ÙŠØª (15 Ø¬Ù‡Ø§Ø²)', partner: 'Ø¥ÙƒØ³ØªØ±Ø§', cost: 25000, date: '2024-02-01', status: 'Completed' },
                { id: '100204', item: 'ØµÙŠØ§Ù†Ø© Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© ÙˆØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø±ÙÙ', partner: 'Ø³Ø§ÙƒÙˆ', cost: 4500, date: '2024-02-15', status: 'Rejected', rejectionReason: 'Ø§Ù„Ø³Ø¹Ø± Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ø§Ù‹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø³ÙˆÙ‚' },
                { id: '100205', item: 'ØªÙˆØ±ÙŠØ¯ Ù…Ù„Ø§Ø¨Ø³ Ø£Ø·ÙØ§Ù„ ØµÙŠÙÙŠØ© (300 Ù‚Ø·Ø¹Ø©)', partner: 'Ù…Ø§ÙƒØ³', cost: 12000, date: '2024-03-01', status: 'Completed' },
                { id: '100206', item: 'ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø´Ø±Ø§Ø¦ÙŠØ© Ù„Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªØ§Ø¬Ø©', partner: 'Ø§Ù„Ø¯Ø§Ù†ÙˆØ¨', cost: 50000, date: '2024-03-15', status: 'Withdrawn' },
                { id: '100207', item: 'ØªÙˆØ±ÙŠØ¯ Ø£Ø¯ÙˆÙŠØ© Ø£Ø·ÙØ§Ù„ ÙˆÙ…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©', partner: 'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù†Ù‡Ø¯ÙŠ', cost: 18000, date: '2024-04-01', status: 'Completed' },
                { id: '100208', item: 'Ø­Ù‚Ø§Ø¦Ø¨ Ù…Ø¯Ø±Ø³ÙŠØ© ÙˆØ£Ø¯ÙˆØ§Øª Ù‚Ø±Ø·Ø§Ø³ÙŠØ© (500 Ø·Ø§Ù„Ø¨)', partner: 'Ù…ÙƒØªØ¨Ø© Ø¬Ø±ÙŠØ±', cost: 9500, date: '2024-04-20', status: 'Completed' },
                { id: '100209', item: 'ØªÙˆØ±ÙŠØ¯ Ù…ÙˆØ§Ø¯ ØªÙ†Ø¸ÙŠÙ ÙˆÙ…Ø¹Ù‚Ù…Ø§Øª', partner: 'Ø¨Ù†Ø¯Ø©', cost: 5200, date: '2024-05-10', status: 'Accepted' },
                { id: '100210', item: 'ØªÙˆØ±ÙŠØ¯ Ø«Ù„Ø§Ø¬Ø§Øª Ù„Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªØ§Ø¬Ø© (20 Ø«Ù„Ø§Ø¬Ø©)', partner: 'Ø¥ÙƒØ³ØªØ±Ø§', cost: 32000, date: '2024-06-01', status: 'Pending' },
                { id: '100211', item: 'Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© Ù…Ù†Ø²Ù„ÙŠØ© (ØºØ³Ø§Ù„Ø§Øª + Ù…ÙƒØ§Ù†Ø³)', partner: 'Ø§Ù„Ù…Ù†ÙŠØ¹', cost: 21000, date: '2024-06-15', status: 'Completed' },
                { id: '100212', item: 'Ù…Ù„Ø§Ø¨Ø³ Ø´ØªÙˆÙŠØ© Ù†Ø³Ø§Ø¦ÙŠØ© ÙˆØ±Ø¬Ø§Ù„ÙŠØ©', partner: 'Ø³Ù†ØªØ±Ø¨ÙˆÙŠÙ†Øª', cost: 14000, date: '2024-07-01', status: 'Accepted' },
                { id: '100213', item: 'Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„ÙŠ Ø£Ø³Ø§Ø³ÙŠ (Ø£Ø³Ø±Ù‘Ø© ÙˆØ®Ø²Ø§Ø¦Ù†)', partner: 'Ø§ÙŠÙƒÙŠØ§', cost: 45000, date: '2024-07-20', status: 'Completed' },
                { id: '100214', item: 'Ø£Ø¯ÙˆØ§Øª Ù…Ø·Ø¨Ø® ÙˆÙ…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨Ø®', partner: 'Ø³Ø§ÙƒÙˆ', cost: 7800, date: '2024-08-05', status: 'Completed' },
                { id: '100215', item: 'Ø³Ø¬Ø§Ø¯ ÙˆÙ…ÙØ±ÙˆØ´Ø§Øª Ù„Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', partner: 'Ù‡ÙˆÙ… Ø³Ù†ØªØ±', cost: 19000, date: '2024-08-20', status: 'Pending' },
                { id: '100216', item: 'Ù„ÙˆØ§Ø²Ù… Ù…Ø¯Ø±Ø³ÙŠØ© Ù„Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ', partner: 'Ù…ÙƒØªØ¨Ø© Ø¬Ø±ÙŠØ±', cost: 11000, date: '2024-09-01', status: 'Accepted' },
                { id: '100217', item: 'ØªÙˆØ±ÙŠØ¯ Ø­Ù„ÙŠØ¨ Ø£Ø·ÙØ§Ù„ ÙˆÙ…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ© Ø®Ø§ØµØ©', partner: 'Ø§Ù„ØªÙ…ÙŠÙ…ÙŠ', cost: 22000, date: '2024-09-15', status: 'Completed' },
                { id: '100218', item: 'Ø£Ø¬Ù‡Ø²Ø© ØªØ¯ÙØ¦Ø© Ù„Ù„Ø´ØªØ§Ø¡ (50 Ø¬Ù‡Ø§Ø²)', partner: 'Ø¥ÙƒØ³ØªØ±Ø§', cost: 17500, date: '2024-10-01', status: 'Pending' }
            ];

            Storage.set('supply_orders', testOrders);
            addLog(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${testOrders.length} Ø£Ù…Ø± ØªÙˆØ±ÙŠØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ`, 'ok');

            // Verify
            const saved = Storage.get('supply_orders');
            if (saved && saved.length === testOrders.length) {
                addLog('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­', 'ok');
                // Check all have partners
                const withPartner = saved.filter(o => o.partner && o.partner.length > 0);
                addLog(`âœ… ${withPartner.length} Ù…Ù† ${saved.length} Ø£Ù…Ø± Ù„Ø¯ÙŠÙ‡Ù… Ø´Ø±ÙŠÙƒ Ù…Ù†ÙØ°`, 'ok');
            } else {
                addLog('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙˆØ§Ù…Ø±', 'err');
            }

            alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ 18 Ø£Ù…Ø± ØªÙˆØ±ÙŠØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ!\nØ§Ø°Ù‡Ø¨ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù„Ù„ØªØ­Ù‚Ù‚.');
            renderOrdersTable();
            runAllTests();
        }

        function renderOrdersTable() {
            const orders = Storage.get('supply_orders') || [];
            const tbody = document.getElementById('ordersTable');
            const statusMap = {
                'Completed': '<span style="background:#ecfdf5;color:#059669;padding:2px 8px;border-radius:10px;font-size:.72rem">Ù…ÙƒØªÙ…Ù„</span>',
                'Pending': '<span style="background:#fffbeb;color:#d97706;padding:2px 8px;border-radius:10px;font-size:.72rem">Ù…Ø¹Ù„Ù‚</span>',
                'Accepted': '<span style="background:#eff6ff;color:#2563eb;padding:2px 8px;border-radius:10px;font-size:.72rem">Ù…Ù‚Ø¨ÙˆÙ„</span>',
                'Rejected': '<span style="background:#fef2f2;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:.72rem">Ù…Ø±ÙÙˆØ¶</span>',
                'Withdrawn': '<span style="background:#f3f4f6;color:#6b7280;padding:2px 8px;border-radius:10px;font-size:.72rem">Ù…Ø³Ø­ÙˆØ¨</span>'
            };
            tbody.innerHTML = orders.length ? orders.map((o, i) => `<tr>
            <td>${i + 1}</td>
            <td>${o.item || 'â€”'}</td>
            <td style="font-weight:600;color:#00A59B">${o.partner || '<span style="color:red">âŒ ÙØ§Ø±Øº</span>'}</td>
            <td>${Number(o.cost || 0).toLocaleString('ar-SA')} Ø±.Ø³</td>
            <td>${o.date || 'â€”'}</td>
            <td>${statusMap[o.status] || o.status}</td>
        </tr>`).join('') : '<tr><td colspan="6" style="text-align:center;color:#aaa;padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± ØªÙˆØ±ÙŠØ¯</td></tr>';
        }

        function runAllTests() {
            // Clear previous
            ['ordersTests', 'dataTests', 'pageTests'].forEach(id => document.getElementById(id).innerHTML = '');
            log = [];
            document.getElementById('logBox').innerHTML = '';
            addLog('Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„...', 'ok');

            // ===== DATA TESTS =====
            const keys = ['users', 'beneficiaries', 'cards', 'wallets', 'merchants', 'transactions', 'supply_orders'];
            let totalPass = 0, totalFail = 0, totalWarn = 0;

            keys.forEach(key => {
                const data = Storage.get(key);
                const exists = data && Array.isArray(data) && data.length > 0;
                addTest('dataTests', key, exists, exists ? `${data.length} Ø¹Ù†ØµØ±` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
                if (exists) { totalPass++; addLog(`${key}: ${data.length} Ø¹Ù†ØµØ±`, 'ok'); }
                else { totalFail++; addLog(`${key}: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!`, 'err'); }
            });

            // Check customLabels
            const labels = Storage.get('customLabels');
            addTest('dataTests', 'customLabels', !!labels, labels ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            if (labels) totalPass++; else totalWarn++;

            // ===== ORDERS TESTS =====
            const orders = Storage.get('supply_orders') || [];
            addTest('ordersTests', 'ÙˆØ¬ÙˆØ¯ Ø£ÙˆØ§Ù…Ø± ØªÙˆØ±ÙŠØ¯', orders.length > 0, `${orders.length} Ø£Ù…Ø±`);

            // Test partner field
            const withPartner = orders.filter(o => o.partner && o.partner.trim().length > 0);
            const partnerOk = withPartner.length === orders.length;
            addTest('ordersTests', 'Ø­Ù‚Ù„ Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ù…Ù†ÙØ°', partnerOk,
                `${withPartner.length} Ù…Ù† ${orders.length} Ø£ÙˆØ§Ù…Ø± Ù„Ø¯ÙŠÙ‡Ø§ Ø´Ø±ÙŠÙƒ`);
            if (!partnerOk) {
                const missing = orders.filter(o => !o.partner || o.partner.trim().length === 0);
                missing.forEach(o => addLog(`Ø£Ù…Ø± #${o.id} Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙŠÙƒ Ù…Ù†ÙØ°!`, 'err'));
            }

            // Test statuses
            const statuses = {};
            orders.forEach(o => { statuses[o.status] = (statuses[o.status] || 0) + 1; });
            addTest('ordersTests', 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª', true,
                Object.entries(statuses).map(s => `${s[0]}: ${s[1]}`).join(' | '));

            // Test cost field
            const withCost = orders.filter(o => o.cost && Number(o.cost) > 0);
            addTest('ordersTests', 'Ø­Ù‚Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©', withCost.length === orders.length,
                `${withCost.length} Ø£ÙˆØ§Ù…Ø± Ø¨Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©`);

            // Test date field
            const withDate = orders.filter(o => o.date && o.date.length > 0);
            addTest('ordersTests', 'Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®', withDate.length === orders.length,
                `${withDate.length} Ø£ÙˆØ§Ù…Ø± Ø¨ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­`);

            // Test item field
            const withItem = orders.filter(o => o.item && o.item.length > 0);
            addTest('ordersTests', 'Ø­Ù‚Ù„ Ø§Ù„ØµÙ†Ù', withItem.length === orders.length,
                `${withItem.length} Ø£ÙˆØ§Ù…Ø± Ø¨ÙˆØµÙ ØµØ­ÙŠØ­`);

            // Test merchants exist and match partners
            const merchants = Storage.get('merchants') || [];
            addTest('ordersTests', 'Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ù…Ø³Ø¬Ù„Ø©', merchants.length > 0,
                `${merchants.length} Ù…ØªØ¬Ø±`);
            const merchantNames = merchants.map(m => m.name);
            const partnerMatch = orders.filter(o => merchantNames.includes(o.partner));
            addTest('ordersTests', 'ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ Ù…Ø¹ Ø§Ù„Ù…ØªØ§Ø¬Ø±',
                partnerMatch.length >= orders.length * 0.8,
                `${partnerMatch.length} Ù…Ù† ${orders.length} Ø´Ø±ÙŠÙƒ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù…ØªØ¬Ø± Ù…Ø³Ø¬Ù„`);

            // Total cost
            const totalCost = orders.reduce((s, o) => s + Number(o.cost || 0), 0);
            addTest('ordersTests', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±', true,
                totalCost.toLocaleString('ar-SA') + ' Ø±.Ø³');

            // ===== PAGE TESTS =====
            const pages = [
                'index.html', 'orders.html', 'reports.html', 'cards.html',
                'wallets.html', 'merchants.html', 'pos.html', 'users.html',
                'settings.html', 'support.html'
            ];
            pages.forEach(page => {
                // We check if the page can be fetched
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', page, false);
                try {
                    xhr.send();
                    const ok = xhr.status === 200 || xhr.status === 304;
                    addTest('pageTests', page, ok, ok ? 'Ù…ØªØ§Ø­' : `Ø®Ø·Ø£ ${xhr.status}`);
                    if (ok) totalPass++; else totalFail++;
                    addLog(`${page}: ${ok ? 'Ù…ØªØ§Ø­' : 'Ø®Ø·Ø£ ' + xhr.status}`, ok ? 'ok' : 'err');
                } catch (e) {
                    addTest('pageTests', page, null, 'ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„');
                    totalWarn++;
                    addLog(`${page}: ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„`, 'wrn');
                }
            });

            // Check script.js and style.css
            ['script.js', 'style.css', 'dummy_data.js'].forEach(file => {
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', file, false);
                try {
                    xhr.send();
                    const ok = xhr.status === 200;
                    addTest('pageTests', file, ok, ok ? 'Ù…ØªØ§Ø­' : `Ø®Ø·Ø£ ${xhr.status}`);
                    addLog(`${file}: ${ok ? 'Ù…ØªØ§Ø­' : 'Ø®Ø·Ø£'}`, ok ? 'ok' : 'err');
                } catch (e) { addTest('pageTests', file, null, 'ØªØ¹Ø°Ø±'); }
            });

            // ===== SUMMARY =====
            const statsCompleted = (statuses['Completed'] || 0);
            const statsPending = (statuses['Pending'] || 0);
            const statsAccepted = (statuses['Accepted'] || 0);

            document.getElementById('summaryBox').innerHTML = `
            <div class="sbox s-green"><div class="sv">${totalPass}</div><div class="sl">Ù†Ø§Ø¬Ø­</div></div>
            <div class="sbox s-red"><div class="sv">${totalFail}</div><div class="sl">ÙØ§Ø´Ù„</div></div>
            <div class="sbox s-orange"><div class="sv">${totalWarn}</div><div class="sl">ØªØ­Ø°ÙŠØ±</div></div>
            <div class="sbox s-blue"><div class="sv">${orders.length}</div><div class="sl">Ø£Ù…Ø± ØªÙˆØ±ÙŠØ¯</div></div>
            <div class="sbox s-green"><div class="sv">${statsCompleted}</div><div class="sl">Ù…ÙƒØªÙ…Ù„</div></div>
            <div class="sbox s-orange"><div class="sv">${statsPending}</div><div class="sl">Ù…Ø¹Ù„Ù‚</div></div>
            <div class="sbox s-blue"><div class="sv">${statsAccepted}</div><div class="sl">Ù…Ù‚Ø¨ÙˆÙ„</div></div>
            <div class="sbox s-green"><div class="sv">${merchants.length}</div><div class="sl">Ù…ØªØ¬Ø±</div></div>
        `;

            addLog('Ø§Ù†ØªÙ‡Ù‰ ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… âœ…', 'ok');
            renderOrdersTable();
        }

        // Auto-run on load
        window.onload = () => {
            renderOrdersTable();
            runAllTests();
        };
    </script>

    <script>
        // PWA Service Worker Register
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed!', err));
            });
        }
    </script>

</body>

</html>